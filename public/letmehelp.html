<head>
	<link rel="stylesheet" type="text/css" href="chess.css">
	
	<script src="jquery.js"></script>
	<script src="angular.js"></script>
	<script src="brandNewAi.js"></script>
	<script src="engine.js"></script>

<script>	
	var appModule = angular.module("appModule", []);

	
	function ApplicationController($rootScope, $http, $interval, $timeout) {	
		$rootScope.messages=["."]
// function makeAMove(whatMove,tableNum){
// 	var result=$.ajax({
// 			    type: 'GET',
// 			    url: '/move?m='+whatMove+'&t='+tableNum,
// 			    dataType: 'json',
// 			    success: function() { },
// 			    data: {},
// 			    async: false
// 			});
// 			//wNext=!wNext
// 			return result.responseJSON.table
// }
$rootScope.sendMessage=function(message){
	$rootScope.messages.push(message+' '+Math.random())
}

$rootScope.move = function(whatMove,tableNum) {

			$http.get('/move?m=' + whatMove + '&t=' + $rootScope.tableNum)
				.then(function(response) {
					
					$rootScope.table= response.table

				})

		}
$rootScope.start=function(wName,bName){
	var tableNum=0
	$rootScope.sendMessage('start func called')
	$http.get('/startGame?w='+wName+"&b="+bName)
		.then(function(response) {
					
					$rootScope.tableNum= response.tableNum
					tableNum= response.tableNum
					
					

				})

	if ($rootScope.tableNum>0)return tableNum
	
}

// //app.listen(16789
// var express = require('express');
// var morgan = require('morgan');
// var mongodb = require('mongodb');
// var fs = require('fs');

// var app = express();

// //app.use(express.static('public'))
// app.use(morgan("combined"))

//var cn = 'mongodb://ec2-52-24-20-162.us-west-2.compute.amazonaws.com:17890/chessdb'

// eval(fs.readFileSync('public/brandNewAi.js') + '');
// eval(fs.readFileSync('public/engine.js') + '');



var dletters = ["a", "b", "c", "d", "e", "f", "g", "h"]
// var http = require('http')

$rootScope.stuffToDo=false
$rootScope.whatToDo=""

var whatToMod="lpV"

$rootScope.gamePairCounter=0

$rootScope.heartBeat=1500

var modVal=50	//translates to x1

$interval(function(){
	$rootScope.sendMessage('.')
	
	if($rootScope.stuffToDo&&!$rootScope.tableNum>0){
		$rootScope.sendMessage('1')
		switch($rootScope.whatToDo){
			
			case "startNewGame":
				$rootScope.sendMessage('2')
		
				$rootScope.whatToDo="busy"
			
				//new random then pair of games then decrease counter, then recall
				if(gamePairCounter==0){
					$rootScope.stuffToDo=false
				}else{
					modVal=Math.random()*100
					$rootScope.sendMessage('starting game, playing white')
					$rootScope.playOneGame(true,whatToMod,modVal)	//this will call another game with black when done
					
				}
			
			
			break;
			
			case "moved":
				//eval that move and call for next move
			
			break;
			
			case "finished":
				//check if should call another game and call it
			
			break;
			
			case "busy":
				//do nothing
				
			break;
			
			case "idle":
				//do nothing
				
			break;
			
			case "onHold":
				//there's stuff to do but we're waiting to save processor credit
				
			
			break;
			
			
			
		}	//switch($rootScope.whatToDo)
	}	//if($rootScope.stuffToDo)
	
},$rootScope.heartBeat)



$rootScope.Modtable = function(tableNum, wName, bName) { //class
	
	this.tableNum = tableNum,
	this.wName = wName,
	this.bName = bName,

	
	this.aiToMove=false		//unused
	this.toBeChecked=true		//unused
	this.gameIsOn=true
	this.whiteWon=false
	this.blackWon=false
	this.isDraw=false
	
	this.askWhiteDraw=false
	this.askBlackDraw=false
	
	this.whiteCanForceDraw=false
	this.blackCanForceDraw=false
	
	
	this.learner=false
	this.learnerIsBusy=false
	
	
	
	this.wNext = true,
	this.aiOn = false,
	this.chat = [],
	this.moves = [],
	this.pollNum = 1,
	this.allPastTables = []

	this.created = new Date()
	this.moved = this.created

	this.table = new Array(8) //create 8x8 array
	for(var i = 0; i < 8; i++) {
		this.table[i] = new Array(8)
	}

	for(var j = 2; j < 6; j++) { //make the blanks blank
		for(i = 0; i < 8; i++) {
			this.table[i][j] = [0, 0, 0, false, false]
		}
	}

	for(var i = 0; i < 8; i++) { //row of white pawns

		this.table[i][1] = [0, 0, 0, false, false] //,pawnCanMove]
	}
	for(var i = 0; i < 8; i++) { //NONO row of black pawns
		this.table[i][6] = [0, 0, 0, false, false] //,pawnCanMove]
	}

	this.table[0][0] = [2, 4, 0, true, false] //,rookCanMove]				//rooks		//0 stands for times it moved
	this.table[7][0] = [2, 4, 0, true, false] //,rookCanMove]
	this.table[0][7] = [1, 4, 0, true, false]
	this.table[7][7] = [1, 4, 0, true, false]

	this.table[1][0] = [0, 0, 0, true, false] //,horseCanMove]					//knights
	this.table[6][0] = [0, 0, 0, true, false] //,horseCanMove]
	this.table[1][7] = [0, 0, 0, true, false]
	this.table[6][7] = [0, 0, 0, true, false]

	this.table[2][0] = [0, 0, 0, true, false] //,bishopCanMove]				//bishops
	this.table[5][0] = [0, 0, 0, true, false] //,bishopCanMove]
	this.table[2][7] = [0, 0, 0, true, false]
	this.table[5][7] = [0, 0, 0, true, false]

	this.table[3][0] = [2, 5, 0, true, false] //,queenCanMove]				//w queen
	this.table[4][0] = [2, 9, 0, true, false] //,kingCanMove]				//w king

	this.table[3][7] = [1, 5, 0, true, false]			//b q
	this.table[4][7] = [1, 9, 0, true, false] //,kingCanMove]				//b k

	this.table = addMovesToTable(this.table, true)
		//protectPieces(this.table,true)
		//protectPieces(this.table,false)
}


$rootScope.playOneGame=function(wModded,modType,modVal){
		//var $rootScope.myGame=0
	//var wPNum = players[0].indexOf(req.query.w)
	//var bPNum = players[0].indexOf(req.query.b)
$rootScope.sendMessage('playOneGame called')
	var firstFreeTable = 0

	// function createXData() {
	// 	$rootScope.sendMessage("can't find xData in db, creating..") //header in db

	// 	mongodb.connect(cn, function(err, db) {

	// 		db.collection("tables")
	// 			.insert({
	// 				"tableNum": "xData",
	// 				"firstFreeTable": 1,
	// 				"lobbyChat": [],
	// 				"activeTables": []
	// 			}, function(err3, res) {})
	// 		db.close()

	// 	});
	// }

	//mongodb.connect(cn, function(err, db) {
		// db.collection("tables")
		// 	.findOne({
			// 	tableNum: "xData"
			// }, function(err2, xData) {
			// 	if(xData == null) {

			// 		createXData();

			// 		firstFreeTable = 1
			// 	} else {
			// 		firstFreeTable = xData.firstFreeTable
			// 		xData.firstFreeTable++
			// 	}
			// 	db.collection("tables")
			// 		.save(xData, function(err, doc) {});
			
		
				var initedTable = []
				if(wModded){
					firstFreeTable=$rootScope.start("mod lpV:" + modVal, "standard")
					initedTable = new Dbtable(firstFreeTable, "mod lpV:" + modVal, "standard")
				}else{
					firstFreeTable=$rootScope.start( "standard", "mod lpV:" + modVal)
					initedTable = new Dbtable(firstFreeTable, "standard", "mod lpV:" + modVal)
				}
				$rootScope.table=initedTable.table
				//initedTable.chat=[new String(new Date())]

				// db.collection("tables")
				// 	.insert(initedTable, function(err, doc) {});

				$rootScope.myGame = initedTable

				

				$rootScope.sendMessage('Table should be in DB, thinking on 1st move..')

				$rootScope.playgame($rootScope.myGame,modType,modVal,true,wModded)

				//db.close()

		//	});
	//});


}


	$rootScope.playgame=function(myGame, mt, mv, wNx, wMod) {

		var result = []
		if(wNx==wMod){
			result = ai(myGame.table, myGame.wNext, myGame.allPastTables, mt, mv)			//get modded result
		}else{
			result = ai(myGame.table, myGame.wNext, myGame.allPastTables)
		}
		
		if(result[0][6]){
			//looped
			myGame.gameIsOn=false //looped
		}
			 //		ai	<------------

		if(result.length > 1) { //if there are any moves

			var aiMoveString = result[1][0] // the winning movestring

			var toConsole = [] //to chat?

			toConsole[0] = result[0][2] + " ms." //timeItTook

			for(var i = 1; i < result.length; i++) {

				toConsole[i] = 'Move:' + result[i][0] + ' RMv:' + result[i][2] + ',' + 'Val:' + result[i][1] + 'a' //+

			}

			var sendJson = {
				aimove: aiMoveString,
				fulltable: result,
				toconsole: toConsole
			}
		} else { //can't move

			//eval
			$rootScope.sendMessage('ran into eval bit')

			myGame.gameIsOn = false

			var sendJson = {
				aimove: "",
				fulltable: result
			}
		}
		//} else {
		// var sendJson = {
		// 	error: "error"
		// }
		//}

		//db.close()
		//$rootScope.sendMessage(sendJson);//trick
		$rootScope.sendMessage(' DONE. ')

		if(myGame.gameIsOn) {
			$rootScope.sendMessage('Will move ' + aiMoveString)
			
			$rootScope.move(aiMoveString,myGame.tableNum)

			var toPush = String(myGame.table[dletters.indexOf(aiMoveString[0])][aiMoveString[1] - 1][0]) + //color of whats moving
				myGame.table[dletters.indexOf(aiMoveString[0])][aiMoveString[1] - 1][1] + //piece
				aiMoveString + //the string
				myGame.table[dletters.indexOf(aiMoveString[2])][aiMoveString[3] - 1][0] + //color of whats hit
				myGame.table[dletters.indexOf(aiMoveString[2])][aiMoveString[3] - 1][1] //piece
				
				+new String(new Date())

			// if(!(toPush==myGame.moves[myGame.moves.length-1])){
			myGame.moves.push(toPush)

			myGame.table = moveIt(aiMoveString, myGame.table)
			$rootScope.table=myGame.table

			myGame.wNext = !myGame.wNext

			//myGame.pollNum++ //<---- majd increment a checkTableStatus ha kiertekelte	//nemis

			//evalGame(myGame)

			myGame.pollNum++

				//myGame.toBeChecked = true //tells it to server(itself) to evaluate table

				myGame.moved = new Date().getTime()

			myGame.table = addMovesToTable(myGame.table, myGame.wNext)

			//remember this state for 3fold rule

			myGame.allPastTables.push(createState(myGame.table))
			
			$rootScope.whatToDo='idle'

			//popThem(req.query.t, myGame, 'moved', 'Player moved: ' + aiMoveString) //respond to pending longpolls

			//}
		} else {
			$rootScope.sendMessage('Game finished, evaluating..')
			evalGame(myGame)	
		}
// 		mongodb.connect(cn, function(err, db2) {
// 			db2.collection("tables")
// 				.findOne({
// 					tableNum: myGame.tableNum
// 				}, function(err2, result) {
// 					$rootScope.sendMessage('found table:' + result.tableNum)

// 					if(myGame.gameIsOn) {
// 						result.table = myGame.table
// 						result.moves = myGame.moves
// 						result.pollNum = myGame.pollNum
// 						result.wNext = myGame.wNext
// 						result.moved = myGame.moved
// 						result.allPastTables = myGame.allPastTables
// 					} else {
// 						result.gameIsOn = false //as it's just finished
// 						result.blackWon = myGame.blackWon
// 						result.whiteWon = myGame.whiteWon
// 						result.isDraw = myGame.isDraw
// 					}

// 					$rootScope.sendMessage('will save moved table..')
// 					db2.collection("tables")
// 						.save(result, function(err3, res) {})

// 					$rootScope.sendMessage('saved. Trying forcepop..')
					
					
					
					
					
					
					
					
					
					
					
					
					
// 					var options = {
// 							host: 'ec2-52-24-20-162.us-west-2.compute.amazonaws.com',
// 							port: 80,
// 							path: '/forcePopTable?t=' + myGame.tableNum
// 						};

// http.request(options, function(response) {
// 								var resJsn = {};

// 								//another chunk of data has been recieved, so append it to `resJsn`
// 								response.on('data', function(chunk) {
// 									resJsn = JSON.parse(chunk);
// 								});

// 								response.on('end', function() {
// 									/////////

							
// 									/////////

// 								});
// 							})
// 							.end();

					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
// 					db2.close()
// 					$rootScope.sendMessage('closed.')

// 					// var optionsb = {
// 					// 	host: 'localhost',
// 					// 	port: 80,
// 					// 	path: '/forcePopTable?t=' + myGame.tableNum + '&p=learner&m=move: ' + aiMoveString
// 					// };

// 					//http.request(optionsb, function(response){

// 					// 	$rootScope.sendMessage('jott vmi')

// 					// 	response.on('data', function(chunk) {
// 					// 	//resJsn = JSON.parse(chunk);
// 					// });

// 					// response.on('end', function() {
// 					// 	});

// 					//}).end()

					if(myGame.gameIsOn) {

						$rootScope.playWhenReady(myGame,mt,mv,!wNx, wMod)
						
						

					} else {

						//not calling this function anymore, should recall with opposit color just once
						$rootScope.sendMessage('eval2 bit')
						
						
						if(wModded) {
							$rootScope.sendMessage('Starting rematch (play black)')
							$timeout($rootScope.playOneGame(false,modType,modVal),2000)
						}else{
							$rootScope.sendMessage('lowering counter then start new gamepair or quit')
							gamePairCounter--
							$rootScope.whatToDo="startNewGame"
						}
						
					}
					
					
// 				});
// 		});

	}



// app.get('/startLearningGame', function(req, res) {
	
	$rootScope.sendMessage('Sending response to start request...???nope')

				// res.json({
				// 	message: "starting..."
				// });
	//playOneGame(true,'lpV',-100)
	//playOneGame(false,'lpV',-100)
	$rootScope.playWhenReady=function(myGame,mt,mv,wNx, wMod){
			$rootScope.sendMessage('recalling playgame (new move)')
						if($rootScope.whatToDo=="busy"){
							$timeout($rootScope.playWhenReady(myGame,mt,mv,wNx, wMod),2000)
						}else{
							$timeout($rootScope.playgame(myGame,mt,mv,wNx, wMod),2000)
						}
						
						
	
	}
	$rootScope.stuffToDo=true
	$rootScope.whatToDo="startNewGame"
	gamePairCounter=-1
	
	
	
	
	}
appModule.controller("ApplicationController", ApplicationController);

// });

// var server = app.listen(16778, function() {

// 	var host = server.address().address;
// 	var port = server.address().port;

// 	$rootScope.sendMessage('learningserver is listening at http://%s:%s', host, port);

// });
</script>
</head>
<body ng-app="appModule"  ng-controller="ApplicationController">
	<table>
		<tr>
			
				<td class="ideRakd" ng-include="'/wtable.html'"></td>
			
			<td>
	tablenum: {{tableNum}}
		{{gamePairCounter}}
		{{stuffToDo}}
	{{whatToDo}}
	<p ng-repeat="x in messages" ng-init=".">{{x}}</p>
			</td>
		</tr>
	</table>
	
	
</body>