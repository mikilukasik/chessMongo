<html>

<head>
	<script src="jquery.js"></script>
	<script src="angular.js"></script>
	<script>
	var appModule = angular.module("appModule", []);

	appModule.controller("ApplicationController", ApplicationController);

	function ApplicationController($rootScope, $scope, $http, $interval, $compile) {

		var dletters = ["a","b","c","d","e","f","g","h"]
		var dfigures = ["","King","Queen","Rook","Bishop","Knight","Pawn"]
		var dcolors = ["","Black","White"]

		$scope.inOrOut = 'Login' //displayed on nav when not logged in
		$scope.loggedIn = false
		$scope.lobbyPollNum = 0

		//$rootScope.tempMoveString = ""
		$rootScope.pollNum = -2
		//$rootScope.table = []
		

		$scope.login = function(user) {
			// if(!(user.pwd == undefined || user.name == undefined)) {
			// 	//alert('logging in '+user.name+' with password '+user.pwd)
			// }

			$http.get("/checkUserPwd?n=" + user.name + '&p=' + user.pwd)
				.success(function(response) {
					if(response.exists) {
						if(response.denied) {
							//wrong pwd
							alert("Username and password don't match, please try again!")
						} else {
							//all good, log him in
							//ask server to log user in ang generate unique login ID. this html will poll the server with that unique ID so you can't be logged in from 2 stations

							//alert("User logged in.")
							$scope.loggedIn = true
							$scope.greetUser = 'Logged in as ' + user.name + '. '

							$scope.inOrOut = 'Logoff' //displayed on nav when logged in
							$rootScope.loginName = user.name
							$scope.showView('lobby.html')

							if(!$scope.$$phase) {
								$scope.$apply()
							}
						}
					} else {
						//username not in DB
						alert('User not registered, please register first!')
					}

				})

		}
		$scope.askToStart = function(opponentsName) {
			if(opponentsName!=$rootScope.loginName)	$http.get('/startGame?w=' + $rootScope.loginName + "&b=" + opponentsName)

		}

		$scope.drawTable = function(wPlayer) {

				// var dfigures = ["", "King", "Queen", "Rook", "Bishop", "Knight", "Pawn"]
				// var dcolors = ["", "Black", "White"]

			$(".ideRakd").empty();
			var appendTable = $('<table class="main-table"> border="1"')
			$(".ideRakd").append(appendTable)

			if($('.main-table').height() < $('.main-table').width()) {

				var atHeight = $('.main-table').height();
				$('.main-table').css({
					'width': atHeight
				});

			} else {

				var atWidth = $('.main-table').width();
				$('.main-table').css({
					'height': atWidth
				});

			}

			if(wPlayer) {

				for(var i = 0; i < 9; i++) {
					var rowEndTr = $('</tr>')
					if(i == 0) {
						var rowTr = $('<tr class="heading row' + i + '">')
						var rowNumber = ""

					} else {
						var rowTr = $('<tr class="row' + i + '">')
						var rowNumber = (9 - i)
					}
					var firstTd = $('<td class="left-column">' + rowNumber + '</td>')
					$(".main-table").append(rowTr)
					$(".row" + i).append(firstTd)

					for(var j = 0; j < 8; j++) {
						if(i == 0) {
							$(".row" + i).append($('<td>' + dletters[j].toUpperCase() + '</td>'))
						} else {
							if((i + j) & 1) {
								$(".row" + i).append($compile($('<td ng-click="clickedItTrans(' + i + ',' + j + ')" ng-app="appModule" ng-controller="ApplicationController" class="square ' + dletters[j] + (9 - i) + '"></td>'))($scope))
							} else {
								$(".row" + i).append($compile($('<td ng-click="clickedItTrans(' + i + ',' + j + ')" ng-app="appModule" ng-controller="ApplicationController" class="darker ' + dletters[j] + (9 - i) + '"></td>'))($scope))
							}
						}

					};
					$(".main-table").append(rowEndTr)
					if(!$scope.$$phase) {
								$scope.$apply()
							}
				}

			} else {

				for(var i = 8; i >= 0; i--) {
					var rowEndTr = $('</tr>')
					if(i == 8) {
						var rowTr = $('<tr class="heading row' + i + '">')
						var rowNumber = ""

					} else {
						var rowTr = $('<tr class="row' + i + '">')
						var rowNumber = (8 - i)
					}
					var firstTd = $('<td class="left-column">' + rowNumber + '</td>')
					$(".main-table").append(rowTr)
					$(".row" + i).append(firstTd)

					for(var j = 7; j >= 0; j--) {
						if(i == 8) {
							$(".row" + i).append($('<td>' + dletters[j].toUpperCase() + '</td>'))
						} else {
							//var stuffToAppend=
							if((i + j + 1) & 1) {
								$(".row" + i).append($compile($('<td ng-click="clickedItTrans(' + (i + 1) + ',' + j + ')" ng-app="appModule" ng-controller="ApplicationController" class="square ' + dletters[j] + (8 - i) + '"></td>'))($scope))
							} else {
								$(".row" + i).append($compile($('<td ng-click="clickedItTrans(' + (i + 1) + ',' + j + ')" ng-app="appModule" ng-controller="ApplicationController" class="darker ' + dletters[j] + (8 - i) + '"></td>'))($scope))
							}
						}

					};
					$(".main-table").append(rowEndTr)

				}

			}

			//console.log("drawTable done")

		}

		$scope.askToWatch = function(gameID) {

			$http.get('/watchGame?v=' + $rootScope.loginName + "&t=" + gameID)

		}
		$scope.applyIt=function(){
			$scope.$apply()
		}
		
		
		$scope.getAndShowTable = function() {

			//console.log('polling table ' + $rootScope.tableNum)

			$http.get('/getTable?t=' + $rootScope.tableNum)
				.success(function(response) {
					$rootScope.table = response.table
					$rootScope.wNext = response.next
					$scope.allMoves = response.allmoves
					$rootScope.chatLines = response.chat
					$rootScope.pollNum=response.tablepollnum

					$scope.refreshRecentGames()
					$scope.showTable()

				})

		}
		$scope.setTableNum = function(num){
			$rootScope.tableNum=num
			$rootScope.pollNum=-1
			$scope.refreshTable()
		}
		$scope.refreshRecentGames = function() {

			////console.log('polling table ' + $rootScope.tableNum)

			$http.get('/getMyRecentGames?n=' + $rootScope.loginName)
				.success(function(response) {
					$scope.myRecentGames = response.recentgames
					//$scope.$apply()

					//$scope.showTable()

				})

		}

		$scope.pollLobby = function() {
			$scope.lobbyPromise = $interval(function() {

				//refreshLobby()
				if($scope.viewName == 'lobby.html') {

					$http.get('/getLobby?p=' + $rootScope.loginName)
						.success(function(response) {
							//console.log('polling lobby')
							if(response.asktoopen) {
								//console.log('opening')

								$rootScope.tableNum = response.opentablenum
								$scope.wPlayer = response.opentablecolor
								$scope.opponentsName = response.opponentsname
								$rootScope.pollNum = 0

								$scope.openNow = true;

							}

							if(!($scope.lobbyPollNum == response.lobbypollnum)) {

								////console.log('polling lobby')

								$scope.lobbyChatLines = response.lobbychat
								$scope.players = response.players
								$scope.players.unshift("Computer")
								
								$scope.games = response.games
								$scope.players.sort(function(a, b) {
									return a.toLowerCase().localeCompare(b.toLowerCase());
								});
								$scope.lobbyPollNum = response.lobbyPollNum
									//showLobby(lobbyChatLines, players, games, $scope.lobbyPollNum)
								if(!$scope.$$phase) {
								$scope.$apply()
							}

							}
							if($scope.openNow) {
								$rootScope.tempMoveString=""
								$scope.viewName = "board.html"
								
								$scope.openNow = false

								// 		window.setTimeout(function() {
								//  $scope.drawTable(true)

								//     $scope.$apply();
								// }, 3000);

							}

						}) //lobbypoll callback ends here
				} else {
					//itt kene mast pollozni
					//console.log($rootScope.tempMoveString)

					if($scope.viewName == 'board.html'&& $rootScope.tempMoveString=="") {
						//console.log('refreshtable called from interval '+ $rootScope.tempMoveString)
						$scope.refreshTable()
						
					}

				}
			}, 500); //setinterval stuff ends here

		}

		$scope.pollLobby()

		$scope.clickedItTrans = function(i, j) {
			//alert("called")
			//console.log([i,j,$rootScope.tempMoveString])
			
			var clickedField = [j, 8 - i]
			var clickedString = dletters[j] + (9 - i)

			if(!($scope.opponentsName == "Spectator")) {
				$scope.clickedIt(clickedField, clickedString)
			}
			//	//console.log(clickedField,clickedString)

		}
		
		$scope.makeAMove = function(whatMove) {

			$http.get('/move?m=' + whatMove + '&t=' + $rootScope.tableNum)
				.success(function(response) {
					$rootScope.wNext = !$rootScope.wNext
					$rootScope.pollNum-=5
					$scope.refreshTable()
					return response.table

				})

		}

		$scope.refreshTable = function() {

			$http.get('/getTPollNum?t=' + $rootScope.tableNum)
				.success(function(response) {
					//console.log('getting board pollnum: '+response.tablepollnum+" vs "+$rootScope.pollNum)
					if(!(response.tablepollnum == $rootScope.pollNum)) {
						$rootScope.pollNum = response.tablepollnum
						//console.log('calling getandshow')
						$scope.getAndShowTable()
						if(!$scope.$$phase) {
								$scope.$apply()
							}
					}

				})

		}

		$scope.showTable = function() { //this will update the displayed table from the array
			for(var i = 0; i < 8; i++) {
				for(var j = 0; j < 8; j++) {

					var thisFigure = $('<img src="cPiecesPng/' + $rootScope.table[i][j][0] + $rootScope.table[i][j][1] + '.png" alt=' + dcolors[$rootScope.table[i][j][0]][0] + dfigures[$rootScope.table[i][j][1]] + '></img>')

					if($rootScope.table[i][j][8] == true || $rootScope.table[i][j][9] == true) {

						thisFigure.addClass('selected');
					} else {

					}
					var thisSquare = "." + dletters[i] + (j + 1)

					$(thisSquare).empty();

					$(thisSquare).append(thisFigure);

				}
			}
			// showTableStatus()
			// showChat()
			if(!$scope.$$phase) {
								$scope.$apply()
							}
		}

		$scope.register = function(user) {

			if(user.pwd1 == user.pwd2) {
				if(!(user.pwd1 == undefined || user.rName == undefined || user.rName == "")) {
					//check if existing, if not then register in db

					$http.get("/checkUser?n=" + user.rName)
						.success(function(response) {
							if(response.exists) {
								alert('Name already exists, try another!')
							} else {
								$http.get('/newUser?n=' + user.rName + '&p=' + user.pwd1)
									.success(function(response) {
										alert(user.rName + ' registered.')
									})
							}
						});

					//alert('registering '+user.rName+' with password '+user.pwd1)

				}
			} else {
				alert("Passwords don't match, try again!")
			}
		}

		$scope.viewName = "login.html";

		$scope.newView = function(viewName) {
			if(viewName == 'board.html') {
				if($scope.wPlayer){
						$scope.drTable("wtable.html")
				}else{
					$scope.drTable("btable.html")
				}
			}
		}
		
		$scope.drTable = function(viewName) {
			$scope.draTable = viewName;
		}
		$scope.showView = function(viewName) {
			$scope.viewName = viewName;

			if(viewName == 'lobby.html'||viewName == 'board.html') {
				$scope.openNow = false
					//$scope.lobbyPollNum=0	
					$rootScope.tempMoveString=""
				/////////////////////////////////		////lobby polling

				// $scope.pollLobby()

				//}
			} else {

				if(viewName == 'login.html') {
					//$interval.cancel($scope.lobbyPromise)
				// }
				// if(viewName == 'login.html') {
					$scope.greetUser = ''
					$scope.inOrOut = 'Login'
					$rootScope.loginName = 'someone'
					$scope.loggedIn = false
				}
			}
		}

		$scope.clickedIt = function(clickedField, clickedString) {

			var x = clickedField[0]
			var y = clickedField[1]
			var clickedColor = false
			
				//alert("called")
				// //console.log([x,y,clickedString])
				// //console.log($rootScope.table)
			if((!($rootScope.table[x][y][5] == []) || $rootScope.tempMoveString.length > 0) && $rootScope.wNext == $scope.wPlayer) {

				if(clickedString == $rootScope.tempMoveString) {
					$rootScope.table[x][y][8] = false
					$scope.clearHighlights()
					$scope.showTable()
					$rootScope.tempMoveString = ""
				} else {
					if($rootScope.table[x][y][0] > 0 && $rootScope.tempMoveString == "") {

						$rootScope.table[x][y][5].forEach($scope.highLightThem) //5odik elem ahova lephet
						$scope.showTable()
							////console.log($rootScope.tempMoveString)
					};
					if($rootScope.table[x][y][0] > 0 || 0 < $rootScope.tempMoveString.length) {

						$rootScope.tempMoveString += clickedString

						if($rootScope.tempMoveString.length < 3) {
							$rootScope.table[x][y][8] = true;
						}

					}
					if($rootScope.tempMoveString.length > 3) {

						if($rootScope.table[x][y][9] == true) {

							$scope.makeAMove($rootScope.tempMoveString)
							$rootScope.wNext = !$rootScope.wNext

							$rootScope.tempMoveString = ""

						} else {
							$rootScope.tempMoveString = $rootScope.tempMoveString[0] + $rootScope.tempMoveString[1]
						}

					}
					$scope.showTable()

				}
			}
		}
		$scope.highLightThem = function(arrayOfCoords) {
			$rootScope.table[arrayOfCoords[0]][arrayOfCoords[1]][9] = true;
		}

		$scope.clearHighlights = function() {
			for(var i = 0; i < 8; i++) {
				for(var j = 0; j < 8; j++) {
					$rootScope.table[i][j][8] = false;
					$rootScope.table[i][j][9] = false;

				}
			}
		}
		$scope.sendChat= function (){
			
			$http.get('/chat?t='+$rootScope.tableNum+'&c='+$rootScope.loginName+": "+$scope.sendThis)
				
					
					
	
			$scope.sendThis=""
			
		}
	}

	</script>
</head>

<body ng-app="appModule" ng-controller="ApplicationController">


	<style>
	
		.centered {
		/*height: 600px;
		width: 600px;*/
		text-align: center;
	}
	
		
	.greyed {
		color: grey
	}	
	
	.selected {
		background-color: orange;
	}
	nav {
		background-color: lightblue;
		
			}
	
	html,
	body {
		/*height: 98%;*/
		/*overflow-x: scroll;*/
	}
	.ideRakd {
		/*height: 600px;
		width: 600px;*/
		
		/*http://blog.brianjohnsondesign.com/maintain-aspect-ratio-for-html-element-using-only-css-in-a-responsive-design/
		*/
		
		width: 60%;
		height: 0;
		padding-bottom: 60%;
	}
	
	.main-table {
		/*height: 600px;
		width: 600px;*/
		text-align: center;
		border: 1px solid black;
		/*height: 600px*/
		
		
		
		
	}
	
	
	.rotate90 {
		-webkit-transform: rotate(90deg);
		-moz-transform: rotate(90deg);
		-o-transform: rotate(90deg);
		-ms-transform: rotate(90deg);
		transform: rotate(90deg);
	}
	
	.square img {
		width: 80%;
		height: auto;
		;
	}
	
	.darker img {
		width: 80%;
		height: auto;
		;
	}
	
		
		.square {
			width: 12.2vw;
			height: 12.2vw;
			/*padding-bottom: 12.2%;*/
			
			
		}
		
		.darker {
			width: 12.2vw;
			height: 12.2vw;
			/*padding-bottom: 12.2%;*/
			
			background-color:  silver;
		}
		
	
	.heading {
		height: 24px;
		background-color: grey;
	}
	
	.left-column {
		width: 24px;
		background-color: grey;
	}
	.myGamesHere{
		width: 120px;
		border-top: 2px solid white;
		border-bottom: 2px solid white;
		/*height: 600px*/
	}
	.statusCell {
		display: block;
		text-align-content: stretch;
		/*height: 100%;*/
		width: 100px;
		overflow-y: scroll;
		
	}
	.leftBar{
		width: 120px;
		height: 400px;
		margin: 0;
		padding: 0;
		/*overflow: auto;*/
		background-color: lightblue;
	}
	.scrollThis{
		/*width: 114px;*/
		height: 400px;
		/*margin: 0;
		padding: 0;*/
		overflow-y: scroll;
	}
	.chatTextTr {
		/*height: 100%;*/
	}
	
	.chatCell {
		display: block;
		text-align-content: stretch;
		height: 600px;
		/*width: 220px;*/
		/*width: 300px;
  		*/
		overflow-y: scroll;
	}
	body{
		height: 90%
	}
	.frame-table {
		/*border: 1px solid lightblue;*/
		/*background-color: lightblue;*/
		/*height:606px;*/

	}
	.lbborder{
		border: 1px solid lightblue;
		
	}
	.wborder{
		border: 1px solid white;
		
	}
	
	.hatszaz {
		height: 600px;
	}
	
	.statusTr {
		/*height: 100%;*/
	}
	
	.leftTable {
		background-color: lightblue;
		height:500px;
		overflow: scroll;
	}
	
	.pointed {
		cursor: pointer;
	}
	
	.recentGames{
		
		/*text-align-content: stretch;*/
		/*height: 100%;*/
		/*width: 100px;*/
		
	}
	.chatInput {
		width: 100%
	}
	/*.selected {
		background-color: yellow;
		
		
	}*/
	/*table {
  		
	}*/

	</style>
	<nav width=100%>
		<table>
			<tr>
				<td nowrap align="left">
		<a href="#" ng-click="showView('login.html')" ng-class="{ selected: viewName == 'login.html' }">{{inOrOut}}</a>
		<a href="#" ng-click="showView('lobby.html')" ng-class="{ selected: viewName == 'lobby.html' }">Lobby</a>
		<a href="#" ng-click="showView('board.html')" ng-class="{ selected: viewName == 'board.html' }">Chessboard</a>
		</td>
		
		<td nowrap width=100% align="right">{{greetUser}}</td>
		</tr>
		</table>
	</nav>
	<div id="content" ng-include="viewName" onload="newView(viewName)">

	</div>

</body>

</html>