<html>

<head>
	<script src="jquery.js"></script>
	<script src="angular.js"></script>
	<script>
	var appModule = angular.module("appModule", []);

	appModule.controller("ApplicationController", ApplicationController);

	function ApplicationController($scope, $http) {

		$scope.inOrOut = 'Login'
		$scope.loggedIn = false

		$scope.login = function(user) {
			// if(!(user.pwd == undefined || user.name == undefined)) {
			// 	//alert('logging in '+user.name+' with password '+user.pwd)
			// }

			$http.get("/checkUserPwd?n=" + user.name + '&p=' + user.pwd)
				.success(function(response) {
					if(response.exists) {
						if(response.denied) {
							//wrong pwd
							alert("Username and password don't match, please try again!")
						} else {
							//all good, log him in
							//ask server to log user in ang generate unique login ID. this html will poll the server with that unique ID so you can't be logged in from 2 stations

							//alert("User logged in.")
							$scope.loggedIn = true
							$scope.greetUser = 'Logged in as ' + user.name + '. '
							$scope.viewName = "lobby.html"
							$scope.inOrOut = 'Logout'
							$scope.loginName = user.name
						}
					} else {
						//username not in DB
						alert('User not registered, please register first!')
					}

				})

		}

		$scope.register = function(user) {

			if(user.pwd1 == user.pwd2) {
				if(!(user.pwd1 == undefined || user.rName == undefined || user.rName == "")) {
					//check if existing, if not then register in db

					$http.get("/checkUser?n=" + user.rName)
						.success(function(response) {
							if(response.exists) {
								alert('Name already exists, try another!')
							} else {
								$http.get('/newUser?n=' + user.rName + '&p=' + user.pwd1)
									.success(function(response) {
										alert(user.rName + ' registered.')
									})
							}
						});

					//alert('registering '+user.rName+' with password '+user.pwd1)

				}
			} else {
				alert("Passwords don't match, try again!")
			}
		}

		$scope.viewName = "login.html";

		$scope.showView = function(viewName) {
			$scope.viewName = viewName;
			
			
			
			if(viewName == 'lobby.html') {
			$scope.openNow=false
			$scope.lobbyPollNum=0	
				
				
		/////////////////////////////////		////lobby polling
				$scope.lobbyPromise=$interval(function() {

					//refreshLobby()
					
					$http.get('/getLobby?p=' + $scope.loginName)
						.success(function(response) {
							
							if(response.asktoopen) {
								console.log('opening')
								
								$scope.openTableNum = response.opentablenum
								$scope.openPlayerColor = response.opentablecolor
								$scope.openOpponentsName = response.opponentsname
							
								$scope.openNow = true;
						
							}
							
							if(!($scope.lobbyPollNum == response.lobbyPollNum)) {

								console.log('polling')
		
								$scope.lobbyChatLines = response.lobbychat
								$scope.players = response.players
								$scope.games = response.games
								$scope.players.sort(function(a, b) {
									return a.toLowerCase().localeCompare(b.toLowerCase());
								});
								$scope.lobbyPollNum = response.lobbyPollNum
								//showLobby(lobbyChatLines, players, games, $scope.lobbyPollNum)
		
							}
							if($scope.openNow) {
						
								$scope.viewName="chess.html"
								$scope.openNow = false
									
							}
								
							
							
							
						})//lobbypoll callback ends here
						
					

					
					
					
					
					

				}, 500);//setinterval stuff ends here

				//function refreshLobby() {
					

				//}
			} else {
				
				$interval.cancel($scope.lobbyPromise)
				
				if(viewName == 'login.html') {
					$scope.greetUser = ''
					$scope.inOrOut = 'Login'
					$scope.loginName = 'someone'
					$scope.loggedIn = false
				}
			}
		}

	}

	</script>
</head>

<body ng-app="appModule" ng-controller="ApplicationController">


	<style>
	.selected {
		background-color: orange;
	}

	</style>
	<nav>

		<a href="#" ng-click="showView('login.html')" ng-class="{ selected: viewName == 'login.html' }">{{inOrOut}}</a>
		<a href="#" ng-click="showView('lobby.html')" ng-class="{ selected: viewName == 'lobby.html' }">Lobby</a>
		<a href="#" ng-click="showView('chess.html')" ng-class="{ selected: viewName == 'chess.html' }">Chessboard</a>
		<span width=100% align="right">{{greetUser}}</span>
	</nav>
	<div id="content" ng-include="viewName">

	</div>

</body>

</html>
