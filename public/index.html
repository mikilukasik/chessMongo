<html>

<head>

	<link rel="stylesheet" type="text/css" href="chess.css">

	<!--<script src="js/frameworks/jquery.js"></script>-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.js"></script>
    
    
	<!--<script src="js/frameworks/angular.js"></script>-->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.js"></script>

	<script src="js/all/engine.js"></script>
	<script src="js/all/brandNewAi.js"></script>
	<script src="js/worker/deepening.js"></script>
	<script src="js/all/classes.js"></script>
	<script src="js/index/thinker.js"></script>
    <script src="js/index/onmessageFuncs.js"></script>

    <script src="js/index/learner.js"></script>



	<script>
		
        var indexGlobals={
            myLastUser:'Computer',
            pendingLearners:0
        }
		
		
		
		/////////////////////	temp stuff for debugging	//////////////////////////////////

		var tempConsole

        var testing={
            testAi:function(){
                
                var success=true
                
                var vals={}
                
                console.log('generate inited table')
                vals.initedTable=new Dbtable(1,2,3)
                
                console.log('make e2e4 move')
                moveInTable('e2e4',vals.initedTable)
                
                console.log('use singleThreadAi function (depth 3)')
                vals.firstResult=singleThreadAi(vals.initedTable,3)
                
                if(vals.firstResult.result.length==20){
                    console.log(".result.length is 20")
                }else{
                    throw new Error('.result.length is not 20')
                    console.log('.result.length:',vals.firstResult.result.length)
                    success=false
                }
                if(vals.firstResult.winningMove.moveTree=='b8c6,f2f3,0,g8f6,0'){
                    console.log(".winningMove.moveTree is 'b8c6,f2f3,0,g8f6,0'")
                }else{
                    throw new Error(".winningMove.moveTree is not 'b8c6,f2f3,0,g8f6,0'")
                    console.log('.winningMove.moveTree:',vals.firstResult.winningMove.moveTree)
                    success=false
                }
                if(vals.firstResult.winningMove.score==1504){
                    console.log(".winningMove.score is 1504")
                }else{
                    throw new Error('.winningMove.score is not 1504')
                    console.log('.winningMove.score:',vals.firstResult.winningMove.score)
                    success=false
                }
                
                
                return success
                
                
                
                
            }
        }
        
        

        ///////////global vars////////////////
        
        
        var store={
            
            oopsStates:[]
            
            
        }


		//////////////////////////	cookie stuff	////////////////////////////////////////////////

		function setCookie(cname, cvalue, exdays) {

			var d = new Date();

			d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));

			var expires = "expires=" + d.toUTCString();

			document.cookie = cname + "=" + cvalue + "; " + expires;

		}

		function getCookie(cname) {

			var name = cname + "=";
			var ca = document.cookie.split(';');

			for (var i = 0; i < ca.length; i++) {
				var c = ca[i];
				while (c.charAt(0) == ' ') c = c.substring(1);
				if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
			}

			return "";

		}


		//init cookie vars

		var cookieId = ""
		var workerSpeed = ""
		var mainThreadSpeed = ""
		var cookieIdRnd = ""

		var clientMongoId = ''
		var userMongoId = ''


		//load cookies

		cookieId = getCookie("myID");
		cookieIdRnd = getCookie("rndId");

		clientMongoId = getCookie("clientMongoId");
		userMongoId = getCookie("userMongoId");



		if (cookieIdRnd == "") {
			cookieIdRnd = (Math.random() * Math.random()).toString()
			setCookie("rndId", cookieIdRnd, 365)
		}

		console.log('cookieIdRnd', cookieIdRnd)

		if (workerSpeed == "" || isNaN(workerSpeed)) {

			workerSpeed = 1 
		}

		var sendID;

		if (cookieId == "") {



			sendID = cookieIdRnd



		}

		var setID = function(id) {

			setCookie("myID", id, 365)
			cookieId = id
			sendID = id

			//should send some rename info to server to rename me!!!!!!!!!!!!!!!!!!!!!


		}



		var setWorkerSpeed = function(count, time) {

			var tempSpeed = Number(count) / Number(time)

			var percDiff = ~~(tempSpeed / Number(workerSpeed) * 100)

			tempSpeed = (workerSpeed + 2 * tempSpeed) / 3 //average of last few

			workerSpeed = tempSpeed

			setCookie("workerSpeed", workerSpeed, 365)

			return percDiff

		}

		var setSpeedCookies = function() {

			setWorkerSpeed(workerSpeed, 1)

		}




		/////////////////////	websocket stuff		//////////////////////////////////

		var showTable = function() {}

		var socketOn = false

		var socketID = undefined

		var socketSend = function(command, data, message, cb) {}


		function updateView($rootScope, $scope, data) {

			//console.log('updateview called',data)

			if ($rootScope.loginVals.viewName == data.viewName) {


				if ($rootScope.subViewName == data.subViewName) {
					//we're on the right view

					
					//$rootScope[data.viewPart]=data.data
                    eval("($rootScope." + data.viewPart + "=data.data)")

					switch(data.viewPart){
						
						case 'dbTable.table':
						    console.log('table received')
                            
							$rootScope.showTable();
											
								

								// $rootScope.$apply
							//})
								
						break;
						
						case 'wPlayer':
						
							if($rootScope.wPlayer){
								
								$rootScope.draTable='wtable.html'
								
								
							}else{
								
								$rootScope.draTable='btable.html'
								
								
							}
						
						break;
						
					}


				} else {
					//view must have changed, let the server know maybe...
					
				}

			} else {
				//view must have changed, let the server know maybe...

			}

			$rootScope.$apply()

		}


		function sockets($rootScope, $scope) {
			if ("WebSocket" in window) {

				socketOn = true
					
				// Let us open a web socket
				var ws = new WebSocket('ws://' + document.location.host+ '/sockets/' );

				ws.onopen = function() {
					// Web Socket is connected, send data using send()




					socketSend = function(command, data, message, cb) {

						var sendThis = {

							command: command,
							data: data,
							message: message,
							socketID: socketID
						}

						if (!cb) {
							var cb = function() {}
						}

						ws.send(JSON.stringify(sendThis), cb());

					}

					console.log("socket connected, let's say hello...")

					socketSend('Hello', {
							cookieIdRnd: cookieIdRnd,
							clientMongoId: clientMongoId
						}, 'Hello', function() {}) 

				};

				ws.onmessage = function(evt){
                    wsOnmessageFunc(evt,$rootScope,$scope,ws,indexGlobals)
                }

				ws.onclose = function() {
					// websocket is closed.

					socketOn = false

					socketID = undefined

					console.log("socketConnection is closed, retry in 2s..");

					window.setTimeout(function() {
						if (!socketOn) sockets($rootScope, $scope)
					}, 2000)
				};
			} else {
				// The browser doesn't support WebSocket
				console.log("WebSocket NOT supported by your Browser!");
			}
		}


		var appModule = angular.module("appModule", []);

		appModule.controller("ApplicationController", ApplicationController)	
			
        appModule.filter('reverse', function() {
            return function(items) {
                return items.slice().reverse();
            };
        });
        
        // appModule.filter('wrotate',function(){
        
        //     return function (inTable){
                
                
                
        //         //console.log(inTable)
                
        //         if(inTable){
                    
        //             var outTable=new Array(8)
                    
		// 			for (var i = 0; i < 8; i++) {
                        
        //                 outTable[i]=new Array(8)
                        
		// 				for (var j = 0; j < 8; j++) {

        //                     outTable[i][j] = new Array(8)
		// 					outTable[i][j] = inTable[j][7 - i]
        //                     //outTable[i][j][1] = inTable[j][7 - i][1]

		// 					if ((i + j) & 1) outTable[i][j][7] = true
                            
		// 				}
		// 			}
                
        //             return outTable
                    
        //         }
                
                
        //     }
        // })
		
        // appModule.filter('brotate',function(){
        
        //     return function (inTable){
                
                
                
        //         console.log(inTable)
                
        //         if(inTable){
                    
        //             var outTable=new Array(8)
                    
		// 			for (var i = 0; i < 8; i++) {
                        
        //                 outTable[i]=new Array(8)
                        
		// 				for (var j = 0; j < 8; j++) {

        //                     outTable[i][j] = new Array(8)
		// 					outTable[i][j] = inTable[7-j][i]
        //                     //outTable[i][j][1] = inTable[7-j][i][1]

		// 					if ((i + j) & 1) outTable[i][j][7] = true
                            
		// 				}
		// 			}
                
        //             return outTable
                    
        //         }
                
                
        //     }
        // })
		
		appModule.directive('wtable', [function() {
			return {
				restrict: 'E',
				scope: {
					'input': '=',
					'clickfunc': '=',
					'myclass': '=',
					'imgh': '=',
					'imgv': '=',
					// imgPathStr1:'@',
					// imgPathStr2:'@'
				},
                link: function(scope, element, attrs) {
                   
                    //console.log(scope.input)
                   
                    scope.$watch('input',function(oldValue,newValue){
                        
                        // console.log('oldValue',oldValue)
                        // console.log('newValue',newValue)
                        
                        scope.outTable=new Array(8)
                    
                        for (var i = 0; i < 8; i++) {
                            
                            scope.outTable[i]=new Array(8)
                            
                            for (var j = 0; j < 8; j++) {

                                scope.outTable[i][j] = new Array(8)
                                scope.outTable[i][j] = scope.input[j][7 - i]
                                //outTable[i][j][1] = inTable[j][7 - i][1]

                                if ((i + j) & 1) scope.outTable[i][j][7] = true
                                
                            }
                        }
                    
                        console.log(scope.outTable)
                        
                        
                    },true)
                   
                    
                   
                   
                   
                   
                },
				template: '<table class="{{myclass}}" onload="updateSizes()" style="width:{{sizempl}}%">\
							<tr class="heading row0">\
								<td class="left-column"></td>\
								<td>A</td>\
								<td>B</td>\
								<td>C</td>\
								<td>D</td>\
								<td>E</td>\
								<td>F</td>\
								<td>G</td>\
								<td>H</td>\
							</tr>\
							<tr ng-repeat="(xIndex, x) in outTable">\
								<td class="left-column">{{8-$index}}</td>\
								<td ng-repeat="(yIndex, y) in x" ng-click="clickfunc(xIndex+1,yIndex)" ng-class="{ darker: y[7], square: !y[7]}">\
									<div ng-class="divAroundIt">\
										<img ng-src="{{\'cPiecesPng/\'+y[0]+y[1]+\'.png\'}}" height="{{imgh}}" width="{{imgw}}" ng-class="{ selected: y[8]||y[9], selected2: y[15]}">\
									</div>\
								</td>\
							</tr>\
						</table>'
	
			}
		}])
		
		
		appModule.directive('btable', [function() {
			return {
				restrict: 'E',
				scope: {
					'input': '=',
					'clickfunc': '=',
					'myclass': '=',
					'imgh': '=',
					'imgv': '=',
					// imgPathStr1:'@',
					// imgPathStr2:'@'
				},
                link: function(scope, element, attrs) {
                   
                    //console.log(scope.input)
                   
                    scope.$watch('input',function(oldValue,newValue){
                        
                        // console.log('oldValue',oldValue)
                        // console.log('newValue',newValue)
                        
                        scope.outTable=new Array(8)
                    
                        for (var i = 0; i < 8; i++) {
                            
                            scope.outTable[i]=new Array(8)
                            
                            for (var j = 0; j < 8; j++) {
                                
                                
                                

                                scope.outTable[i][j] = new Array(8)
                                scope.outTable[i][j] = scope.input[7-j][i]
                                

                                if ((i + j) & 1) scope.outTable[i][j][7] = true     //makes grey fields grey
                                
                            }
                        }
                    
                        console.log(scope.outTable)
                        
                        
                    },true)
                   
                    
                   
                   
                   
                   
                },
				template: '<table class="{{myclass}}" onload="updateSizes()"">\
							<tr class="heading row0">\
								<td class="left-column"></td>\
								<td>H</td>\
								<td>G</td>\
								<td>F</td>\
								<td>E</td>\
								<td>D</td>\
								<td>C</td>\
								<td>B</td>\
								<td>A</td>\
							</tr>\
							<tr ng-repeat="(xIndex, x) in outTable">\
								<td class="left-column">{{1+$index}}</td>\
								<td ng-repeat="(yIndex, y) in x" ng-click="clickfunc(8-xIndex,7-yIndex)" ng-class="{ darker: y[7], square: !y[7]}">\
									<div ng-class="divAroundIt">\
										<img ng-src="{{\'cPiecesPng/\'+y[0]+y[1]+\'.png\'}}" height="{{imgh}}" width="{{imgw}}" ng-class="{ selected: y[8]||y[9], selected2: y[15]}">\
									</div>\
								</td>\
							</tr>\
						</table>'
	
			}
		}])
        
        
		function ApplicationController($rootScope, $scope, $timeout, $http, $interval, $compile) {
			
			$rootScope.imgPathStr1='cPiecesPng/'
			$rootScope.imgPathStr2='.png'
			
			
            testing.getDbTable=function(){
                return $rootScope.dbTable
            }
            
            testing.getAi=function(depth){
                if(!depth)depth=3
                return singleThreadAi(testing.getDbTable(),depth)
            }
            
			$rootScope.temp1={}
            $scope.temp2={}
			
			$rootScope.alertButton=function(thisCase,passData){
				
				switch (thisCase){
					
					case 'Accept challenge+Accept, play with white.':
						
						$scope.quickGame(passData.opponentsName,passData.challenger)
						
						
					break;
					
					case 'Accept challenge+Accept, play with black.':
						
						$scope.quickGame(passData.challenger,passData.opponentsName)
						
						
					break;
					
					case 'Accept challenge+Accept':
					
						if(passData.wPlayer){
							$scope.quickGame(passData.opponentsName,passData.challenger)
						}else{
							$scope.quickGame(passData.challenger,passData.opponentsName)
						}
					
					
					break;
					
					case 'Challenge player+White':
					
						console.log('challenging '+passData.opponentsName+' with white.')
						
						socketSend('challenge',{
							opponentsName:passData.opponentsName,
							wPlayer:true
						})
						
						
						
					break;
					case 'Challenge player+Black':
					
						console.log('challenging '+passData.opponentsName+' with black.')
						socketSend('challenge',{
							opponentsName:passData.opponentsName,
							wPlayer:false
						})
						
					break;
					case "Challenge player+Opponent's choice":
						
						console.log('challenging '+passData.opponentsName+", who get's to chose color.")
					socketSend('challenge',{
							opponentsName:passData.opponentsName,
							opponentsChoice:true
						})
						
					break;
					case "Challenge player+Random color":
						socketSend('challenge',{
							opponentsName:passData.opponentsName,
							wPlayer:(Math.random()>0.5)
						})
						console.log('jooo')
					break;
					
					
				}
				
				$rootScope.alertData=undefined
				
			}
			
            
            
			$rootScope.autoButtonOnCountDown=function(alertID,countDown,callWithText){
				
				if($rootScope.alertData&&$rootScope.alertData.alertID==alertID){
					
					if(countDown>0){
						
						$rootScope.alertCountDown=countDown
						$timeout(function(){
							$rootScope.autoButtonOnCountDown(alertID,countDown-1,callWithText)
						},1000)
					}else{
						
							$rootScope.alertButton(callWithText)
						
					}
				}
			}
			
			$rootScope.alertUser=function(heading,paragraph,buttons,passData,countDown,defaultButton){
				
				var alertID=Math.random()
				
				$rootScope.alertData={
					
					h:heading,
					p:paragraph,
				
					buttons:buttons,
					passData:passData,
					
					defaultButton:defaultButton,
					
					alertID:alertID
					
				}
				
				$timeout(function(){        //this should be some onload!!!!!!!!!!!!!!!!!!!!!!!!!!!!1
					
					 $( "#autoFoc" ).focus();
				
				},100) 
				
				$rootScope.autoButtonOnCountDown(alertID,countDown,heading+'+'+defaultButton)
			
			}
			
	
			
			if (!$rootScope.ran) {
				
				$rootScope.loginVals = {
					inOrOut: 'Login',
					viewName: 'login.html'
				}
                
                $rootScope.depth = 3
			}

			if (!socketOn) sockets($rootScope, $scope)




			var pollerMessage = function(event) {

				//console.log('something')

				switch (event.data.resCommand) {

					case undefined:

						break;

					case 'updateBusyThinkers':

						//		console.log(event.data.resData.busyThinkers)

						$rootScope.busyThinkers = event.data.resData.busyThinkers
						$scope.$apply()
						$rootScope.updateSizes()

						break;


				}


			}

			
			$rootScope.cookieId = cookieId

			$rootScope.setID = function(id) {

				setID(id)

				$rootScope.cookieId = id


			}

			$scope.refreshAllBrowsers = function() {

				socketSend('refreshAllBrowsers')

			}

			$scope.setDepth = function(depth) {
				$rootScope.depth = depth
			}

			$rootScope.updateSizes = function(cb) {

				

				console.log('updateSizes')

				
				var sw = window.innerWidth
				var sh = window.innerHeight

				var sr = sh / sw

				if (sr < 0.8) {
					$rootScope.screenRatio = 0
				} else {

					if (sr < 1.1) {
						$rootScope.screenRatio = 1
					} else {

						if (sr < 1.5) {
							$rootScope.screenRatio = 2
						} else {
							$rootScope.screenRatio = 3
						}


					}

				}



				var nw = $('.navvv').width()
				var sbh = $('.statusBox').height()

				$('.frame-table').css({
					'width': nw + 'px'
				});
				$('.frame-table').css({
					'height': (sh - 50) + 'px'
				});



				switch ($rootScope.screenRatio) {

					case 0:

						$('.leftBar').css({
							'width': 130 + 'px'
						});


						$('.iderakd').css({
							'height': (1) + 'px'
						});
						$('.iderakd').css({
							'width': (1) + 'px'
						});

						$('.main-table').css({
							'height': (sh - 72) + 'px'
						});
						$('.main-table').css({
							'width': (sh - 72) + 'px'
						});


						$('.chatCell').css({
							'width': (sw - sh - 90) + 'px'
						});
						$('.chatCell').css({
							'height': (sh - 92) + 'px'
						});

						$('.chatInpt').css({
							'width': (sw - sh - 144) + 'px'
						});

						$('.moves').css({
							'height': (sh - sbh - 75) + 'px'
						});


						break;

					case 1:

						$('.leftBar').css({
							'width': 230 + 'px'
						});



						$('.tableAndChat').css({
							'width': (nw - 241) + 'px'
						});


						$('.chatCell').css({
							'width': (nw - 214) + 'px'
						});
						$('.chatCell').css({
							'height': (sh - sw + 342) + 'px'
						});

						$('.chatInpt').css({
							'width': (nw - 268) + 'px'
						});


						$('.iderakd').css({
							'height': (1) + 'px'
						});
						$('.iderakd').css({
							'width': (1) + 'px'
						});


						$('.main-table').css({
							'height': (nw - 215) + 'px'
						});
						$('.main-table').css({
							'width': (nw - 215) + 'px'
						});


						$('.moves').css({
							'height': (sh - sbh + 112) + 'px'
						});

						

						break;

					case 2:

						$('.leftBar').css({
							'width': 130 + 'px'
						});


						$('.tableAndChat').css({
							'width': (1) + 'px'
						});

						$('.iderakd').css({
							'height': (1) + 'px'
						});
						$('.iderakd').css({
							'width': (1) + 'px'
						});



						$('.chatCell').css({
							'width': (nw - 150) + 'px'
						});
						$('.chatCell').css({
							'height': (sh - nw + 42) + 'px'
						});

						$('.chatInpt').css({
							'width': (nw - 214) + 'px'
						});



						$('.main-table').css({
							'height': (nw - 150) + 'px'
						});
						$('.main-table').css({
							'width': (nw - 150) + 'px'
						});

						$('.moves').css({
							'height': (sh - sbh - 82) + 'px'
						});

						

						break;

					case 3:




						$('.leftBar').css({
							'height': (sh - nw - 68) + 'px'
						});

						$('.chatCell').css({
							'width': (nw - 148) + 'px'
						});
						$('.chatInpt').css({
							'width': (nw - 202) + 'px'
						});


						$('.chatCell').css({
							'height': (sh - nw - 90) + 'px'
						});

						$('.iderakd').css({
							'height': (1) + 'px'
						});
						$('.iderakd').css({
							'width': (1) + 'px'
						});

						$('.main-table').css({
							'height': (nw - 8) + 'px'
						});
						$('.main-table').css({
							'width': (nw - 8) + 'px'
						});

						$('.moves').css({
							'height': (sh - sbh - nw - 73) + 'px'
						});



						break;

				}
				
				if (cb) {
					
					cb()
				}
                if(!$scope.$$phase) {
                    $scope.$apply()
                }
			}

			window.onresize = function() {


				//http://stackoverflow.com/questions/14902321/how-to-determine-if-a-resize-event-was-triggered-by-soft-keyboard-in-mobile-brow


				var t = $(document.activeElement).prop('type')
				if (t === 'text' || t === 'password') {
					// Logic for while keyboard is shown
				} else {
					// Logic for while keyboard is hidden
                    
					setTimeout($rootScope.updateSizes(), 800)


				}

			}

			var dletters = ["a", "b", "c", "d", "e", "f", "g", "h"]

			$scope.lobbyPollNum = 0

			$rootScope.pollNum = -2 //!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			


			$scope.askToStart = function(opponentsName) {
				
				if (opponentsName != $rootScope.loginName) {
				
					$rootScope.alertUser('Challenge player',"You're about to challenge "+opponentsName+". Choose your color:",['White','Black',"Opponent's choice","Random color",'Cancel'],{
						opponentsName:opponentsName
					},10,'Cancel')
			
				}else{
					
					//clicked to challange himself
					
					
				}
					
			}
 

			$scope.askToWatch = function(gameID) {

				$http.get('/watchGame?v=' + $rootScope.loginName + "&t=" + gameID)

			}
			$rootScope.applyIt = function() {

				console.log('should apply')

				if (!$scope.$$phase) {

					console.log('does apply')
					$scope.$apply()

				} 

			}

			$scope.quickGame = function(w,b) {


				socketSend('quickGame', {
					w: w,
					b: b
				}, 'startQuickGame for w:' + w +' b:'+b, function() {
					console.log("'startGame' callback")
				})

			}

			$scope.setTableNum = function(num) {

				var oldNum = $rootScope.dbTable._id

				$rootScope.dbTable._id = num
				$rootScope.pollNum = -1

				$http.get('/forcePopTable?t=' + oldNum + '&p=' + $rootScope.loginName + '&m=Went to t' + num)
				$rootScope.longPollTable()

			}

			
			$scope.clickedItTrans = function(i, j) {
				
				console.log('clickedItTrans',i,j)
				
				var clickedField = [j, 8 - i]
				var clickedString = dletters[j] + (9 - i)

				if (!($scope.opponentsName == "Spectator")) {
					$scope.clickedIt(clickedField, clickedString)
				}
				
			}

			$scope.makeAMove = function(whatMove) {

					var moveStr = whatMove

					var dbTable = $rootScope.dbTable 
                       	
                    dbTable.command = ''
						
                    store.oopsStates[$rootScope.dbTable._id]=$.extend(true, {}, dbTable)
					
					$scope.clearHighlights(store.oopsStates[$rootScope.dbTable._id].table)
					
					dbTable = moveInTable(moveStr, dbTable, false)
                       
                       
                    dbTable._id = $rootScope.dbTable._id
					dbTable.desiredDepth = $rootScope.depth
                    
                    


					if (dbTable.wName == 'Computer' || dbTable.bName == 'Computer') {
						
                        dbTable.command = 'makeAiMove'
                        dbTable.moveTask=new MoveTaskN(dbTable)
                      
					}


					
					socketSend('moved', dbTable, 'moved', function() {

						$rootScope.dbTable.table = dbTable.table
						$rootScope.dbTable.wNext = dbTable.wNext
						$rootScope.dbTable.moves = dbTable.moves
                        
					})

			}

			$rootScope.takeItBack = function() {
				socketSend('moved', store.oopsStates[$rootScope.dbTable._id], 'moved', function() {
                    
					$rootScope.dbTable.table = store.oopsStates[$rootScope.dbTable._id].table
					$rootScope.dbTable.wNext = store.oopsStates[$rootScope.dbTable._id].wNext
					$rootScope.dbTable.moves = store.oopsStates[$rootScope.dbTable._id].moves

				})
			}

			$scope.refreshTable = function() {

				$http.get('/getTPollNum?t=' + $rootScope.dbTable._id)
					.success(function(response) {
						
                        if (!(response.tablepollnum == $rootScope.pollNum)) {
							$rootScope.pollNum = response.tablepollnum
								////console.log('calling getandshow')
							$rootScope.longPollTable()
							if (!$scope.$$phase) {
								$scope.$apply()
							}
						}

					})

			}

			$rootScope.showTable = function(cb) { //this will update the displayed table from the array

				
				var tt
				if ($rootScope.stable) {
					tt = $rootScope.stable
					console.log('got prev. table')
				} else {
					console.log('else called')
					tt = new Dbtable(1, 2, 3).table
				}

				if ($rootScope.wPlayer) {

					for (var i = 0; i < 8; i++) {

						for (var j = 0; j < 8; j++) {

							var theSame = (tt[i][j][0] == $rootScope.dbTable.table[i][j][0])

							tt[i][j] = $rootScope.dbTable.table[i][j]

							if (!theSame) tt[i][j][15] = true

							//if ((i + j) & 1) tt[i][j][7] = true
						}
					}

				} else {

					for (var i = 0; i < 8; i++) {

						for (var j = 0; j < 8; j++) {

							var theSame = (tt[i][j][0] == $rootScope.dbTable.table[i][j][0])

							tt[i][j] = $rootScope.dbTable.table[i][j]

							if (!theSame) tt[i][j][15] = true

							//if ((i + j) & 1) tt[i][j][7] = true

						}
					}




				}




				$rootScope.stable = tt
                
                //$rootScope.$apply()    

                console.log('showTable lefutott')


				//consoleTable=$rootScope.dbTable.table
                // if(!$scope.$$phase) {
                //     $scope.$apply()
                // }
				

				if (cb) {
                    cb()
                    console.log('showTable had cb',cb)
                }

			}

			showTable = $rootScope.showTable

			$scope.login = function(user) {

				socketSend('loginUser', {
					name: user.name,
					pwd: user.pwd,
					stayLoggedIn: user.stayLoggedIn
				})


			}

			$scope.register = function(user) {

				if (user.pwd1 == user.pwd2) {
					if (!(user.pwd1 == undefined || user.rName == undefined || user.rName == "")) {


						socketSend('registerUser', {
							name: user.rName,
							pwd: user.pwd1
						})

					}
				} else {
					$rootScope.alertUser('Password mismatch',"Passwords don't match, try again!",['OK'],{},5,'OK')
				}
			}
			
			
			
			$scope.adminButtons=function(func,client,data){
                
				switch(func){
					
					case 'runClientSpeedTest':
					
						socketSend('clientSpeedTest',client)
					
					break;
					
					case 'refreshBrowser':
					
						socketSend('refreshBrowser',client)
					
					break;
					
					case 'setLastUser':
						client.setLastUserTo=data
						socketSend('setLastUser',client)
					
					break;
					
					case 'learnerCount':
                        if(data>=0){
                           client.learnerCount=Number(data)
					   	   socketSend('learnerCount',client)
                        }
						
					
					break;
					
                    case 'removeFromAllMods':
                    
                        socketSend('removeFromAllMods',data)
                    
                    break;
                    
                    case 'setModValMin':
                        client.setModValMin=data
                        socketSend('setModValMin',client)
                    
                    break;
                    
                    case 'setModValMax':
                        client.setModValMax=data
                        socketSend('setModValMax',client)
                    
                    break;
                    
                    case 'addMod':
                    
                        if(data!=''&&data!=undefined){
                            client.addMod=data
                            socketSend('addMod',client)
                            data=''
                            
                            if(client.connectionID=='default'){
                                $rootScope.temp1.modToAdd=''
                            }
                            
                        }
                        
                        // $rootScope.modToAdd=''
                        
                    break;
                    
                    case 'removeMod':
                    
                        client.removeModIndex=data
                        socketSend('removeMod',client)
                    
                    break;
                    
                    case 'customModCheckbox':
                    
                    
                        //console.log(data)
                        client.customModCheckbox=data
                        socketSend('customModCheckbox',client)
                    
                    break;
					
					case 'reporting':
                    
                    	client.connectionID=socketID
						client.learningOn=indexGlobals.myLastUser
                        console.log('reporting',client)
                        //client.customModCheckbox=data
                        socketSend('reporting',client)
                    
                    break;
					
					
					
					
				}
				
				
			}

			$scope.newView = function(viewName) {
				if (viewName == 'board.html') {


					// $timeout($rootScope.updateSizes(), 800)

					if ($rootScope.wPlayer) {
						$scope.drTable("/wtable.html")
					} else {
						$scope.drTable("/btable.html")
					}
				} else {
					if (viewName == 'login.html') {

						focusOnLogin()

					} else {


						if (viewName == 'lobby.html') {

						}



					}
				}
			}

			$scope.drTable = function(viewName) {
				$rootScope.draTable = viewName;
			}



			$rootScope.showView = function(viewName, subViewName, requestUpdate) {

				//let the server know what we're watching

				if (!(subViewName)) {

					if (viewName == $rootScope.loginVals.viewName && $rootScope.subViewName) {
						subViewName = $rootScope.subViewName
					} else {
						subViewName = 'default'
					}

				}

				var newViewParts = []
					//var oldViewParts=$rootScope.activeViewParts

				console.log('test', viewName, $rootScope.loginVals.inOrOut)

				switch (viewName) {
					case 'login.html':

						newViewParts = [
							'default'
						]


						//console.log('inorout',$rootScope.inOrOut)
						if ($rootScope.loginVals.inOrOut == 'Logoff') {

							socketSend('logoff', {
								name: $rootScope.loginName
							})
							
							$rootScope.greetUser = ''
							$rootScope.loginVals.inOrOut = 'Login'
							$rootScope.loginName = 'someone'
							$rootScope.loggedIn = false
							$rootScope.isAdmin = false

						}

						


						break;

					case 'lobby.html':

						newViewParts = [
							'lobbyChat',
							'activeGames',
							'onlineUsers'
						]


						//
						break;

					case 'admin.html':

						newViewParts = [
							'clients',
							'activeViews',
                            'splitMoves',
                            'adminLog',
                            'defaultMod',
                            'allMods',
							'learningGames',
                            'learnerTable'
						]

						//

						break;

					case 'board.html':

						//if(subViewName=='default'&&$rootScope.dbTable._id)subViewName=$rootScope.dbTable._id

						newViewParts = [
							'dbTable.table',
							'dbTable.chat',
							'dbTable.moves',
							'busyThinkers',
							'dbTable.wNext',
							'wPlayer'

						]

						break;
				}

				//var oldViewParts=$rootScope.activeViewParts.slice()

				if (!($rootScope.activeViewParts)) $rootScope.activeViewParts = [] //init here

				socketSend('showView', {

					oldViewName: $rootScope.loginVals.viewName,
					oldSubViewName: $rootScope.subViewName,
					oldViewParts: $rootScope.activeViewParts.slice(),

					newViewName: viewName,
					newSubViewName: subViewName,
					newViewParts: newViewParts

				}, 'showView', function() {

					console.log('showView socketSend callback ran')

					$rootScope.loginVals.viewName = viewName;
					$rootScope.subViewName = subViewName;
					$rootScope.activeViewParts = newViewParts.slice()
					
					
					if (requestUpdate) {
					// socketSend('updateMe',{
	
						// })
	
						console.log('here would be "updateMe"')
	
						$rootScope.applyIt()
					} else {
						$rootScope.applyIt()
					}



				})

				

			}
            
            $scope.startAdminLog=function(){
                socketSend('startAdminLog')
            }
            $scope.stopAdminLog=function(){
                socketSend('stopAdminLog')
            }
            $scope.clearAdminLog=function(){
                socketSend('clearAdminLog')
            }

			$scope.clickedIt = function(clickedField, clickedString) {


				var x = clickedField[0]
				var y = clickedField[1]
				var clickedColor = false

				//console.log('testing',$rootScope.dbTable.table[x][y][5] , $rootScope.tempMoveString.length ,$rootScope.dbTable.wNext , $rootScope.wPlayer)	
				if ((!($rootScope.dbTable.table[x][y][5] == []) || $rootScope.tempMoveString.length > 0) && $rootScope.dbTable.wNext == $rootScope.wPlayer) {
					console.log('clickeit called', clickedField, clickedString)

					if (clickedString == $rootScope.tempMoveString) {
						$rootScope.dbTable.table[x][y][8] = false
						$scope.clearHighlights($rootScope.dbTable.table)
						$rootScope.showTable()
						$rootScope.tempMoveString = ""
					} else {

						if ($rootScope.dbTable.table[x][y][0] > 0 && $rootScope.tempMoveString == "") {
							//console.log('testtesttesttesttesttesttesttest')

							for (var i = 0; i < 8; i++) {
								for (var j = 0; j < 8; j++) {
									$rootScope.dbTable.table[i][j][15] = false

								}
							}


							$rootScope.dbTable.table[x][y][5].forEach($scope.highLightThem) //5odik elem ahova lephet
							$rootScope.showTable()

						};
						if ($rootScope.dbTable.table[x][y][0] > 0 || 0 < $rootScope.tempMoveString.length) {

							$rootScope.tempMoveString += clickedString

							if ($rootScope.tempMoveString.length < 3) {
								$rootScope.dbTable.table[x][y][8] = true;
							}

						}
						if ($rootScope.tempMoveString.length > 3) {

							if ($rootScope.dbTable.table[x][y][9] == true) {

								$scope.makeAMove($rootScope.tempMoveString)
								$rootScope.dbTable.wNext = !$rootScope.dbTable.wNext

								$rootScope.tempMoveString = ""

							} else {
								$rootScope.tempMoveString = $rootScope.tempMoveString[0] + $rootScope.tempMoveString[1]
							}

						}
						$rootScope.showTable()

					}
				}
			}
			$scope.highLightThem = function(arrayOfCoords) {
				$rootScope.dbTable.table[arrayOfCoords[0]][arrayOfCoords[1]][9] = true;
			}

			$scope.removeDisplayedGame = function(gameNo) {
				//console.log('removeGame',gameNo)
				socketSend('removeDisplayedGame', gameNo)
			}

			$scope.clearHighlights = function(onTable) {
				for (var i = 0; i < 8; i++) {
					for (var j = 0; j < 8; j++) {
						onTable[i][j][8] = false;
						onTable[i][j][9] = false;

					}
				}
			}
			$scope.sendChat = function(chatLine) {

                console.log('sending chat:',chatLine,$rootScope.dbTable._id)
                
				socketSend('boardChat',{
                    chatLine:chatLine,
                    gameNum:$rootScope.dbTable._id
                },'boardChat: '+chatLine,function(){
                    
                    $rootScope.temp1.chatInput=''
                    
                })

			}

            $scope.sendLobbyChat = function(chatLine) {
                
                //console.log('sending chat:',chatLine)

				socketSend('lobbyChat',{
                    chatLine:chatLine
                },'lobbyChat: '+chatLine,function(){
                    
                    $rootScope.temp1.lobbyChatInput=''
                    
                })
                
                

			}



			$rootScope.updateSizes()
			console.log('appcontr ran')
			
			$scope.instantGame = function(w,b) {


				// $scope.opponentsName = 'Computer'

				socketSend('quickGame', {
					w: $rootScope.loginName,
					b: 'Computer'
				}, 'startQuickGame for w:' + w +' b:'+b, function() {
					console.log("'startGame' callback")
				})

			}



		}
		
	



		function focusOnLogin() {

			window.setTimeout(function() {
					document.getElementById("inputLoginUser").focus();
				}, 500)
				// document.getElementById("inputLoginUser").focus();



		}

		// $scope.firstView=function(){
		// 	showView('login.html')
		// }
	</script>


</head>

<body ng-app="appModule" ng-controller="ApplicationController" class="docuBody">

	<div class="main-div" style="padding-bottom:0px;border-spacing:0px">


		<nav ng-if="ran" style="width: 100%;padding-bottom:0px;border-spacing:0px" class="navvv unselectable">
			<table style="padding-bottom:0px;border-spacing:0px;border-collapse: merge">
				<tr valign="bottom" style="padding-bottom:0px;border-spacing:0px;border-collapse: merge">
					
					<td nowrap>
						<button class="dtext" ng-click="instantGame(loginName,'Computer')">Instant Game</button>
					</td>
					
<!--indening the below leaves spaces between tabs on nav-->
					
<td nowrap style="padding-bottom:0px;border-spacing:0px;border-collapse: merge" valign="bottom"><div style="display: inline-block;white-space: nowrap;padding-bottom:0px;border-spacing:0px"><div style="display: inline-block;white-space: nowrap;" ng-class="{ passiveTab: loginVals.viewName != 'cv.html', activeTab: loginVals.viewName == 'cv.html' }">
&nbsp
<span ng-attr-title="About the author" class="dtext pointed" ng-click="showView('cv.html')">Author</span>
&nbsp
</div></div><div style="display: inline-block;white-space: nowrap;padding-bottom:0px;border-spacing:0px"><div style="display: inline-block;white-space: nowrap;" ng-class="{ passiveTab: loginVals.viewName != 'login.html', activeTab: loginVals.viewName == 'login.html' }">
&nbsp
<span ng-attr-title="Click here to {{loginVals.inOrOut}}" class="dtext pointed" ng-click="showView('login.html')">{{loginVals.inOrOut}}</span>
&nbsp
</div></div><div ng-if="loggedIn" style="display: inline-block;white-space: nowrap;padding-bottom:0px;border-spacing:0px"><div style="display: inline-block;white-space: nowrap;" ng-class="{ passiveTab: loginVals.viewName != 'lobby.html', activeTab: loginVals.viewName == 'lobby.html' }">
&nbsp
<span title="Click here to view the lobby" class="dtext pointed" ng-click="showView('lobby.html')">Lobby</span>
&nbsp
</div></div><div  ng-if="isAdmin" style="display: inline-block;white-space: nowrap;padding-bottom:0px;border-spacing:0px"><div style="display: inline-block;white-space: nowrap;" ng-class="{ passiveTab: loginVals.viewName != 'admin.html', activeTab: loginVals.viewName == 'admin.html' }">
&nbsp
<span title="Hello admin, please click here!" class="dtext pointed" ng-click="showView('admin.html')">Admin</span>
&nbsp
</div></div></td><td nowrap style="width: 100%;padding-bottom:0px;border-spacing:0px;border-collapse: merge" valign="bottom"><div ng-repeat="x in displayedGames" style="display: inline-block;white-space: nowrap;padding-bottom:0px;border-spacing:0px"><div style="display: inline-block;white-space: nowrap;" ng-class="{ passiveTab: loginVals.viewName != 'board.html' || subViewName != x.gameNo, activeTab: loginVals.viewName == 'board.html' && subViewName == x.gameNo }">
&nbsp
<span ng-attr-title="playing {{x.wPlayer&&('white')||('black')}} against {{x.opponentsName}}" class="dtext pointed" ng-click="showView('board.html',x.gameNo,true)">Game {{x.gameNo}}</span><span style="position:relative;top:-1px;background-position: 0px -0.5pt;"ng-click="removeDisplayedGame(x.gameNo)" class="pointed dtext radial">X</span>
</div></div></td>

<td class="dtext" nowrap align="right">{{greetUser}}</td>
				</tr>
			</table>
		</nav>


	</div>

	<div>
		
		
		
		<div ng-if="loginVals.viewName&&loginVals.viewName!=''" id="content" ng-include="'html/'+loginVals.viewName" onload="newView(viewName)">
			
		
		</div>
		<h1 ng-if="!(ran)">Please wait...</h1>

	</div>
	
	<div ng-if="alertData"style="
	
	
	
	
	
	position:absolute; 
	
	height:20vw;
	top:10vw;
	 
	right: 20vw;
    left: 20vw;
	
    margin-right: auto;
    margin-left: auto;
	
	margin-bottom: auto;
    margin-top: auto;
	
	z-index:2;
	
	min-height:200px;
	
 
  
	
	vertical-align:middle;
	
	background-color:rgba(55,55,155,0.8);color:white">
	
		
					<div ng-include="'/html/alert.html'">
							
	</div>
	
	
</body>

</html>