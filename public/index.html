<html>

<head>
	
	<link rel="stylesheet" type="text/css" href="chess.css">
	
	<script src="jquery.js"></script>
	<script src="angular.js"></script>
	<script src="js/engine.js"></script>
	<script src="js/brandNewAi.js"></script>
	<script src="js/deepening.js"></script>
	<script src="js/classes.js"></script>
	<script src="js/thinker.js"></script>
	
	

	<script>
	
		/////////////////////	temp stuff for debugging	//////////////////////////////////
		
		var tempConsole
		
		
		/////////////////////	websocket stuff		//////////////////////////////////
		
		var socketOn=false
		
		var socketID=undefined
		
		var socketSend=function(command,data,message,cb){}
		
		
			function updateView($rootScope,$scope,data){
				
				console.log('updateview called',data)
				
				if($rootScope.viewName==data.viewName){
					
					
					if($rootScope.subViewName==data.subViewName){
						//we're on the right view
						
						
									
								if(data.viewPart=='table') {
									
									eval("($rootScope."+data.viewPart+"=data.data."+data.viewPart+")") // $rootScope.
								
									$rootScope.dbTable.wNext=data.data.wNext
									$rootScope.tempMoveString=''	
									$scope.showTable()
								}else{
									
									eval("($rootScope."+data.viewPart+"=data.data)") // $rootScope.
							
								}
					}else{
					//view must have changed, let the server know maybe...
					
					
					
				}
					
			
					
					
					
					
				}else{
					//view must have changed, let the server know maybe...
					
					
					
				}
				
			}
		
		
		 function sockets($rootScope,$scope) {
            if ("WebSocket" in window)
            {
				
					socketOn=true
               //alert("WebSocket is supported by your Browser!");
               
               // Let us open a web socket
               var ws = new WebSocket('ws://'+document.location.hostname+'/sockets/');
				
               ws.onopen = function()
               {
                  // Web Socket is connected, send data using send()
				  
				  
				  
			
				  socketSend=function(command,data,message,cb){
					  
					  var sendThis={
						 
						  command: command,
						  data: data,
						  message: message,
						  socketID: socketID
					  }
					 
					  if(!cb){
						  var cb=function(){}
					  }
					  
					  ws.send(JSON.stringify(sendThis),cb());
				
				  }
				  
				  console.log("socket connected, let's say hello...")
				  
				  socketSend('Hello',{},'Hello',function(){
					  //console.log("socketSend 'hello' callback called")
				  })	//init
				  
               };
				
               ws.onmessage = function (evt) 
               { 
                  var received = eval("(" + evt.data + ")");
                  
				  console.log("socketMessage received:",received.message,received.data);
				  
				  switch(received.command){
					  
					  case 'reHello' : 
					  
					  	 socketID = received.data.connectionID
					  
					  	console.log('received connectionID',received.data.connectionID)
					  
					  	$rootScope.socketID=received.data.connectionID
						  
						 if(!$rootScope.ran) {
		
							$rootScope.ran=true
							$rootScope.showView('login.html')
						
						}
					  
					  
					  break;
					  
					  case 'openGame':
					  
					  	$rootScope.showView('board.html',received.data._id)
						  
						$rootScope._id=received.data._id	//temp hack!!!!!!!!!!!!!!!!!!!!!!!
						$rootScope.wPlayer = received.data.wPlayer
						
						$rootScope.tempMoveString=""
					  
					  break;
					  
					  
					  case 'showOnConsole':
					  
					  	console.log('showOnConsole received from server',received.data)
					  
					  break;
					  
					  case 'task':
					  
					  
					  	mainWorker.postMessage	
					
						({
																
							reqCommand: 'taskReceived',
							reqData : {
								command:received.data.command,			//string
								data: received.data.data
							}
							
						})
					  
					  
					  
					  


						break;		
						
						case 'updateView':
						
							updateView($rootScope,$scope,received.data)
							
						
						
						
						break;		
						
						case 'updateDbTable':
						
							$rootScope.dbTable=received.data
							tempConsole=received.data
						
						
						break;	  
					  
					  
					  case 'lobbyState':
					  
					  
					  
					  
					  
					  //console.log('polling lobby')
							if(received.data.asktoopen) {
								////console.log('opening')

								$rootScope._id = received.data.opentablenum
								$rootScope.showView('board.html',$rootScope._id)
								$rootScope.wPlayer = received.data.opentablecolor
								$scope.opponentsName = received.data.opponentsname
								$rootScope.pollNum = 0

								$scope.openNow = true;

							}

							if(!($scope.lobbyPollNum == received.data.lobbypollnum)) {

								//////console.log('polling lobby')

								$scope.lobbyChatLines = received.data.lobbychat
								$scope.players = received.data.players
								$scope.players.unshift("Fastest thinker")
								$scope.players.unshift("Multiple thinkers")
								$scope.players.unshift("Server")
								
								
								$scope.games = received.data.games
								$scope.players.sort(function(a, b) {
									return a.toLowerCase().localeCompare(b.toLowerCase());
								});
								$scope.lobbyPollNum = received.data.lobbyPollNum
									//showLobby(lobbyChatLines, players, games, $scope.lobbyPollNum)
								if(!$scope.$$phase) {
								$scope.$apply()
							}

							}
							// if($scope.openNow) {
							// 	$rootScope.tempMoveString=""
							// 	$rootScope.viewName = "board.html"
							// 	$rootScope.subViewName = $rootScope._id
								
							// 	$scope.openNow = false

							// 	// 		window.setTimeout(function() {
							// 	//  $scope.drawTable(true)

							// 	//     $scope.$apply();
							// 	// }, 3000);

							// }

					  
					  
					  
					  
					  
					  
					  break;
					  
					  
				  }
				  
				  
				  
               };
				
               ws.onclose = function()
               { 
                  // websocket is closed.
				  
				  socketOn=false
				  
				  socketID=undefined
				  
                  console.log("socketConnection is closed, retry in 2s.."); 
				  
				  setTimeout(function(){
					  if(!socketOn)sockets($rootScope, $scope)
				  },2000)
               };
            }
            
            else
            {
               // The browser doesn't support WebSocket
               console.log("WebSocket NOT supported by your Browser!");
            }
         }
	
	
	
	
	
	
	
	
	
		//////////////////////////	cookie stuff	////////////////////////////////////////////////

		function setCookie(cname, cvalue, exdays) {
			
			var d = new Date();
			
			d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
			
			var expires = "expires=" + d.toUTCString();
			
			document.cookie = cname + "=" + cvalue + "; " + expires;
			
		}

		function getCookie(cname) {
			
			var name = cname + "=";
			var ca = document.cookie.split(';');
			
			for (var i = 0; i < ca.length; i++) {
				var c = ca[i];
				while (c.charAt(0) == ' ') c = c.substring(1);
				if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
			}
			
			return "";
			
		}


		//init cookie vars

		var cookieID = ""
		var workerSpeed = ""
		var mainThreadSpeed = ""
		var rndID=""


		//load cookies

		cookieID = getCookie("myID");
		rndID = getCookie("rndID");
		
		// mainThreadSpeed = Number(getCookie("mainThreadSpeed"));
		// workerSpeed = Number(getCookie("workerSpeed"));
		

		if (workerSpeed == "" || isNaN(workerSpeed)) {

			workerSpeed = 1 //temp val before first test		//should this be 0????
			
		}
		
		var sendID;

		if (cookieID == "") {
			
			if(rndID == ""){
				rndID = ~~(Math.random() * 1000000000000000)
				setCookie("rndID", rndID, 365)
			}
			
			sendID=rndID

			
		} else {
			
			sendID = cookieID
			
		}

		var setID = function(id) {
			
			setCookie("myID", id, 365)
			cookieID = id
			sendID = id

			//should send some rename info to server to rename me!!!!!!!!!!!!!!!!!!!!!


		}
		
		
		
		var setWorkerSpeed = function(count, time) {
			
			var tempSpeed=Number(count) / Number(time)
			
			var percDiff=~~(tempSpeed/Number(workerSpeed)*100)
			
			tempSpeed=(workerSpeed+2*tempSpeed)/3		//average of last few
			
			workerSpeed = tempSpeed
	
			setCookie("workerSpeed", workerSpeed, 365)
			
			return percDiff
				
		}

		var setSpeedCookies = function() {

			setWorkerSpeed(workerSpeed,1)
		
		}

		

		
		
		
		
		ifWorkers(startWorkers)
		
		//var activeViewParts=[]
		
		
		
		
		
		
	var appModule = angular.module("appModule", []);

	appModule.controller("ApplicationController", ApplicationController);

	function ApplicationController($rootScope, $scope, $timeout, $http, $interval, $compile) {
		
		if($rootScope.dbTable==undefined)$rootScope.dbTable={}
		
		//$rootScope.activeViewParts=activeViewParts
		
		
		
		if(!socketOn)sockets($rootScope, $scope)
	
	
		
		 
		
		var pollerMessage= function(event){
			
			//console.log('something')
			
			switch (event.data.resCommand){
				
				case undefined:
				
				break;
				
				case 'updateBusyThinkers':
				
			//		console.log(event.data.resData.busyThinkers)
					
					$rootScope.busyThinkers=event.data.resData.busyThinkers
					$scope.$apply()
					$rootScope.updateSizes()
				
				break;
				
				
			}
			
			
		}
		
		var poller={}
		
		ifWorkers(function(){
			
			poller=new Worker('js/poller.js')
			poller.onmessage = pollerMessage
			
			
			
		},function(){
			//no worker support
			
			
			
		})
		
		
		
		
		$rootScope.cookieID=cookieID
		
		$rootScope.setID=function(id){
			
			setID(id)
			
			$rootScope.cookieID=id
			
			
		}
		
		
		
		$scope.setDepth=function(depth){
			$rootScope.depth=depth
		}
		
		$rootScope.updateSizes=function(){
			
			var sw=window.innerWidth
			var sh=window.innerHeight
			
			var sr=sh/sw
			
			if(sr<0.8){
				$rootScope.screenRatio=0
			}else{
				
				if(sr<1.1){
					$rootScope.screenRatio=1
				}else{
					
					if(sr<1.5){
						$rootScope.screenRatio=2
					}else{
						$rootScope.screenRatio=3
					}
					
					
				}
				
			}
			
			
			
			var nw=$('.navvv').width()
			var sbh=$('.statusBox').height()
			
			$('.frame-table').css({'width':nw+'px'});
			$('.frame-table').css({'height':(sh-50)+'px'});
			
			
			
			switch ($rootScope.screenRatio) {
				
				case 0:
				
				$('.leftBar').css({'width':130+'px'});
				
					
					$('.iderakd').css({'height':(1)+'px'});
					$('.iderakd').css({'width':(1)+'px'});
					
					$('.main-table').css({'height':(sh-72)+'px'});
					$('.main-table').css({'width':(sh-72)+'px'});
					
						
					$('.chatCell').css({'width':(sw-sh-90)+'px'});
					$('.chatCell').css({'height':(sh-92)+'px'});
					
					$('.chatInpt').css({'width':(sw-sh-144)+'px'});
					
					$('.moves').css({'height':(sh-sbh-75)+'px'});
				
				break;
				
				case 1:
				
					$('.leftBar').css({'width':230+'px'});
			
		
					
					$('.tableAndChat').css({'width':(nw-241)+'px'});
					
					
					$('.chatCell').css({'width':(nw-214)+'px'});
					$('.chatCell').css({'height':(sh-sw+342)+'px'});
					
					$('.chatInpt').css({'width':(nw-268)+'px'});
					
					
					$('.iderakd').css({'height':(1)+'px'});
					$('.iderakd').css({'width':(1)+'px'});
					
					
					$('.main-table').css({'height':(nw-215)+'px'});
					$('.main-table').css({'width':(nw-215)+'px'});
					
					
					$('.moves').css({'height':(sh-sbh+112)+'px'});
					
					
				
				
				break;
				
				case 2:
				
					$('.leftBar').css({'width':130+'px'});
					
					
					$('.tableAndChat').css({'width':(1)+'px'});
					
					$('.iderakd').css({'height':(1)+'px'});
					$('.iderakd').css({'width':(1)+'px'});
					
					
					
					$('.chatCell').css({'width':(nw-150)+'px'});
					$('.chatCell').css({'height':(sh-nw+42)+'px'});
					
					$('.chatInpt').css({'width':(nw-214)+'px'});
					
					
					
					$('.main-table').css({'height':(nw-150)+'px'});
					$('.main-table').css({'width':(nw-150)+'px'});
					
					$('.moves').css({'height':(sh-sbh-82)+'px'});
					
				
				break;
				
				case 3:
				
					
					
								
					$('.leftBar').css({'height':(sh-nw-68)+'px'});
					
					$('.chatCell').css({'width':(nw-148)+'px'});
					$('.chatInpt').css({'width':(nw-202)+'px'});
					
					
					$('.chatCell').css({'height':(sh-nw    -90)+'px'});
					
					$('.iderakd').css({'height':(1)+'px'});
					$('.iderakd').css({'width':(1)+'px'});
					
					$('.main-table').css({'height':(nw-8)+'px'});
					$('.main-table').css({'width':(nw-8)+'px'});
					
					$('.moves').css({'height':(sh-sbh-nw-73)+'px'});
					
				break;
				
			}
			
		}
		
		window.onresize=function(){
			
			
			//http://stackoverflow.com/questions/14902321/how-to-determine-if-a-resize-event-was-triggered-by-soft-keyboard-in-mobile-brow
			
			
			var t=$(document.activeElement).prop('type')
			if(t === 'text' || t === 'password') {
				// Logic for while keyboard is shown
			} else {
				// Logic for while keyboard is hidden
				
				$timeout($rootScope.updateSizes(),800)
				
				
			}
			
		}
		
		var dletters = ["a","b","c","d","e","f","g","h"]
		
		$scope.inOrOut = 'Login' //displayed on nav when not logged in
		$scope.loggedIn = false
		$scope.lobbyPollNum = 0

		$rootScope.pollNum = -2		//just in case
		
		$rootScope.depth=3
		
		$scope.login = function(user) {
			

			$http.get("/checkUserPwd?n=" + user.name + '&p=' + user.pwd)
				.success(function(response) {
					if(response.exists) {
						if(response.denied) {
							//wrong pwd
							alert("Username and password don't match, please try again!")
						} else {
							//all good, log him in
							//ask server to log user in ang generate unique login ID. this html will poll the server with that unique ID so you can't be logged in from 2 stations

							//alert("User logged in.")
							$scope.loggedIn = true
							$scope.greetUser = 'Logged in as ' + user.name + '. '

							$scope.inOrOut = 'Logoff' //displayed on nav when logged in
							$rootScope.loginName = user.name
							$rootScope.showView('lobby.html','default')

							if(!$scope.$$phase) {
								$scope.$apply()
							}
						}
					} else {
						//username not in DB
						alert('User not registered, please register first!')
					}

				})

		}
		$scope.askToStart = function(opponentsName) {
			if(opponentsName!=$rootScope.loginName)	socketSend('startGame',{
				w:$rootScope.loginName,
				b:opponentsName
			},'startGame against '+opponentsName,function(){
				console.log("'startGame' callback")
			})
			//$http.get('/startGame?w=' + $rootScope.loginName + "&b=" + opponentsName)

		}

		// 

		$scope.askToWatch = function(gameID) {

			$http.get('/watchGame?v=' + $rootScope.loginName + "&t=" + gameID)

		}
		$scope.applyIt=function(){
			$scope.$apply()
		}
		
		$scope.quickGame=function(){
			
			
								//$rootScope.showView('board.html',)
			
								//$http.get('/startGame?w=' + $rootScope.loginName + "&b=" + 'Multiple thinkers')
								
								$scope.opponentsName='Multiple thinkers'
								
								socketSend('quickGame',{
									w: $rootScope.loginName,
									b: 'Multiple thinkers'
								},'startQuickGame for '+$rootScope.loginName,function(){
									console.log("'startGame' callback")
								})
								
		}
		
		
		
		$rootScope.longPollTable = function() {

			////console.log('polling table ' + $rootScope._id)

			// $http.get('/longPollTable?t=' + $rootScope._id + '&pn=' + $rootScope.pollNum + '&r=' + Math.random())
			// 	.then(function(responseData) {
			// 		var response=responseData.data
					
			// 		//console.log('Data received: '+response.command+' - '+response.message)
					
			// 		if(response._id==$rootScope._id){		//break poll on changed _id
			// 			//$rootScope.dbTable.table = response.table
						
			// 			if($rootScope.dbTable.table!=undefined){
			// 				//highlight changed squares
			// 				//var changed=false
			// 				for(var i=0;i<8;i++){
			// 					for (var j=0;j<8;j++){
			// 						var theSame=($rootScope.dbTable.table[i][j][0]!=response.table[i][j][0])
			// 						$rootScope.dbTable.table[i][j]=response.table[i][j]
			// 						if(theSame){
			// 							$rootScope.dbTable.table[i][j][15]=true
			// 							//changed=true
			// 						}
			// 					}
			// 				}
							
			// 			}else{
			// 			// 	//
			// 				//just copy the table
			// 				$rootScope.dbTable.table = response.table
			// 			}
			// 			$rootScope.dbTable.tableId=response._id
			// 			$rootScope.dbTable.wNext = response.wNext
			// 			//$scope.allMoves = response.allMoves				//these are my possible moves now
			// 			$rootScope.chatLines = response.chat
			// 			$rootScope.pollNum=response.pollNum
			// 			$rootScope.dbTable.moves=response.moves	
			// 			$rootScope.dbTable.allPastTables=response.allPastTables	
			// 			//$rootScope.dbTable.moves=response.moves										
	
			// 			// $scope.refreshRecentGames()
			// 			$scope.showTable()
			// 			console.log('showing table, viewName',$rootScope.viewName,'subView',$rootScope.subViewName)
			// 			if($rootScope.viewName == "board.html") {			
			// 				console.log('Repeating longpoll on t'+ response._id)			
			// 				$rootScope.longPollTable()	//loop till change view	(or table)
							
							
			// 				$rootScope.updateSizes()
							
							
			// 			}else{
			// 				//console.log('board not displayed (viewName: '+ $rootScope.viewName+'), discontinuing longpoll for table ' + response._id)
							
			// 			}
			// 		}else{
			// 			//console.log('_id changed, discontinuing longpoll for table ' + response._id)
			// 		}
			// 	},function(data){
			// 		$interval($rootScope.longPollTable(),2000)	//retry
			// 	})

		}
		
		$scope.setTableNum = function(num){
			
			var oldNum = $rootScope._id
			
			$rootScope._id=num
			$rootScope.pollNum=-1
			
			$http.get('/forcePopTable?t='+oldNum+'&p='+$rootScope.loginName+'&m=Went to t'+num)
			$rootScope.longPollTable()
		
		}
		$scope.refreshRecentGames = function() {


		}

		$scope.pollLobby = function() {
			
			
			
			
			
			$scope.lobbyPromise = $interval(function() {

				//refreshLobby()
				if($rootScope.viewName == 'lobby.html') {
					
					console.log("'getLobby'??")
					// socketSend('getLobby',{p: $rootScope.loginName},'getLobby',function(){
					// 	console.log("'getLobby' callback")
					// })
				
				} else {
					

				}
			}, 1000); //setinterval stuff ends here

		}

		$scope.pollLobby()			//replaced with socketSend
		
		
		

		$scope.clickedItTrans = function(i, j) {
			//alert("called")
			////console.log([i,j,$rootScope.tempMoveString])
			
			var clickedField = [j, 8 - i]
			var clickedString = dletters[j] + (9 - i)

			if(!($scope.opponentsName == "Spectator")) {
				$scope.clickedIt(clickedField, clickedString)
			}
			//	////console.log(clickedField,clickedString)

		}
		
		$scope.makeAMove = function(whatMove) {

		if(!($scope.opponentsName=='Server')){			// temp hack!!!!!
			
			var moveStr=whatMove	//levagni a kepeket...	(mi ut mit)
			//////////////////////
							///replace this!!!
							
				var dbTable={}//new Dbtable($rootScope._id, $rootScope.wName, $rootScope.bName)
				
				//hello Marzenka
				
				dbTable._id=$rootScope._id
				dbTable.wName=$rootScope.wName
				dbTable.bName=$rootScope.bName
				
				
				dbTable.table=$rootScope.dbTable.table
				dbTable.wNext=$rootScope.dbTable.wNext
																						//refaktor!!!!!!
				dbTable.moves= $rootScope.dbTable.moves
				dbTable.pollNum= $rootScope.pollNum
				dbTable.allPastTables= $rootScope.dbTable.allPastTables
				// dbTable.wName= $rootScope.wName
				// dbTable.bName= $rootScope.bName
				
				$rootScope.lastState= $.extend(true, {}, dbTable)		//remember so we can Oooops!!
				
				
				
				$scope.clearHighlights($rootScope.lastState.table)
				console.log('dbTable',dbTable)
				dbTable=moveInTable(moveStr,dbTable,false)
				
		
			
			
				if($scope.opponentsName=='Fastest thinker'){
					dbTable.command='makeAiMove'
					dbTable.aiType='fastest thinker'
					
						
				}
				
				if($scope.opponentsName=='Multiple thinkers'){
					dbTable.command='makeAiMove'
					dbTable.aiType='thinkers'
					
					
						
					// dbTable.aiTable=new MoveTask(dbTable)	
				}
			
			
			dbTable._id=$rootScope.dbTable.tableId
			dbTable.desiredDepth=$rootScope.depth
			
			socketSend('moved',dbTable,'moved',function(){
				
				$rootScope.dbTable.table=dbTable.table
				$rootScope.dbTable.wNext=dbTable.wNext
				$rootScope.dbTable.moves=dbTable.moves
			})
			
			// $http.post('/moved',dbTable,function(req,res){
			// 	$rootScope.dbTable.table=dbTable.table
			// 	$rootScope.dbTable.wNext=dbTable.wNext
			// 	$rootScope.dbTable.moves=dbTable.moves
				
			// })
			
		}	else{
		
			$http.get('/move?m=' + whatMove + '&t=' + $rootScope._id)
			
			
		}
			

		}
		
		$rootScope.takeItBack= function(){
			socketSend('moved',dbTable,'moved',function(){
				$rootScope.dbTable.table=$rootScope.lastState.table
				$rootScope.dbTable.wNext=$rootScope.lastState.wNext
				$rootScope.dbTable.moves=$rootScope.lastState.moves
				
				//$scope.clearHighlights($rootScope.dbTable.table)
				
			})
		}

		$scope.refreshTable = function() {

			$http.get('/getTPollNum?t=' + $rootScope._id)
				.success(function(response) {
					////console.log('getting board pollnum: '+response.tablepollnum+" vs "+$rootScope.pollNum)
					if(!(response.tablepollnum == $rootScope.pollNum)) {
						$rootScope.pollNum = response.tablepollnum
						////console.log('calling getandshow')
						$rootScope.longPollTable()
						if(!$scope.$$phase) {
								$scope.$apply()
							}
					}

				})

		}

		$scope.showTable = function() { //this will update the displayed table from the array
			
			//shit i need to rotate it first
		
			var tt=[]
			
			//console.log()
			if($rootScope.wPlayer){				
				
				for(var i=0; i<8; i++) {
					tt[i]=[]
					for(var j=0; j<8; j++) {
						tt[i][j]=$rootScope.dbTable.table[j][7-i]
						if((i+j)&1)tt[i][j][7]=true
					}
				}
				
			}else{
				
				for(var i=0; i<8; i++) {
					tt[i]=[]
					for(var j=0; j<8; j++) {
						tt[i][j]=$rootScope.dbTable.table[7-j][i]
						if((i+j)&1)tt[i][j][7]=true
					}
				}
				
				
				
				
				
				
			}
				
			
			
			
			$rootScope.sTable=tt
			
			consoleTable=$rootScope.dbTable.table
			
			//$scope.$apply()
	
		}

		$scope.register = function(user) {

			if(user.pwd1 == user.pwd2) {
				if(!(user.pwd1 == undefined || user.rName == undefined || user.rName == "")) {
					//check if existing, if not then register in db

					$http.get("/checkUser?n=" + user.rName)
						.success(function(response) {
							if(response.exists) {
								alert('Name already exists, try another!')
							} else {
								$http.get('/newUser?n=' + user.rName + '&p=' + user.pwd1)
									.success(function(response) {
										alert(user.rName + ' registered.')
									})
							}
						});

				}
			} else {
				alert("Passwords don't match, try again!")
			}
		}

		//$rootScope.viewName = "login.html";

		$scope.newView = function(viewName) {
			if(viewName == 'board.html') {
				//$scope.refreshRecentGames()
				//console.log('View changed to board, calling longpoll on t'+$rootScope._id)
				$rootScope.longPollTable()		//start longpoll
				
				//console.log(poller)
				
				poller.postMessage({
					reqCommand: 'startBusyThinkersPoll',
					reqData: {
						_id: $rootScope._id
					}
				})
				
				$rootScope.updateSizes()
				
				if($rootScope.wPlayer){
						$scope.drTable("/wtable.html")
				}else{
					$scope.drTable("/btable.html")
				}
			}else{
				if(viewName == 'login.html'){
					
					//forcepop
					
					$http.get('/forcePopTable?t='+$rootScope._id+'&p='+$rootScope.loginName+'&m=user logged out')
					
					
					focusOnLogin()
					 
				}else{
				
				
				if(viewName == 'lobby.html'){
					$http.get('/forcePopTable?t='+$rootScope._id+'&p='+$rootScope.loginName+'&m=user went to lobby')
				}
				
				
				
			}
			}
		}
		
		$scope.drTable = function(viewName) {
			$rootScope.draTable = viewName;
		}
		
		
		
		$rootScope.showView = function(viewName,subViewName) {
			
			//let the server know what we're watching
			
			if(!(subViewName)){
				
				if(viewName==$rootScope.viewName&&$rootScope.subViewName){
					subViewName=$rootScope.subViewName
				}else{
					subViewName='default'
				}
				
			}
			
			var newViewParts=[]
			//var oldViewParts=$rootScope.activeViewParts
			
			switch(viewName){
				case 'login.html':
				
					newViewParts=[
						'default'
					]
					
					
					$scope.greetUser = ''
					$scope.inOrOut = 'Login'
					$rootScope.loginName = 'someone'
					$scope.loggedIn = false
					
				
				break;
				
				case 'lobby.html':
				
					newViewParts=[
						'lobbyChat',
						'activeGames',
						'activePlayers'
					]
					
					
				
				break;
				
				case 'captain.html':
				
					newViewParts=[
						'knownClients'
					]
					
					
				
				break;
				
				case 'board.html':
				
					if(subViewName=='default'&&$rootScope._id)subViewName=$rootScope._id
				
					newViewParts=[
						'table',
						'chat',
						'moves',
						'busyThinkers',
						
					]
								
				break;
			}
			
			//var oldViewParts=$rootScope.activeViewParts.slice()
			
			if(!($rootScope.activeViewParts))$rootScope.activeViewParts=[]//init here
			
			socketSend('showView',{
				
				oldViewName:$rootScope.viewName,
				oldSubViewName:$rootScope.subViewName,
				oldViewParts:$rootScope.activeViewParts.slice(),
				
				newViewName:viewName,
				newSubViewName:subViewName,
				newViewParts:newViewParts
				
			},'showView',function(){
				
				
				
				$rootScope.viewName = viewName;
				$rootScope.subViewName = subViewName;
				$rootScope.activeViewParts= newViewParts.slice()
				
			})
			
				
			
			
		}

		$scope.clickedIt = function(clickedField, clickedString) {

			
			var x = clickedField[0]
			var y = clickedField[1]
			var clickedColor = false
			
		//console.log('testing',$rootScope.dbTable.table[x][y][5] , $rootScope.tempMoveString.length ,$rootScope.dbTable.wNext , $rootScope.wPlayer)	
			if((!($rootScope.dbTable.table[x][y][5] == []) || $rootScope.tempMoveString.length > 0) && $rootScope.dbTable.wNext == $rootScope.wPlayer) {
				console.log('clickeit called',clickedField, clickedString)

				if(clickedString == $rootScope.tempMoveString) {
					$rootScope.dbTable.table[x][y][8] = false
					$scope.clearHighlights($rootScope.dbTable.table)
					$scope.showTable()
					$rootScope.tempMoveString = ""
				} else {
					
					if($rootScope.dbTable.table[x][y][0] > 0 && $rootScope.tempMoveString == "") {
						
						for(var i=0;i<8;i++){
								for (var j=0;j<8;j++){
									$rootScope.dbTable.table[i][j][15]=false
									
								}}	
						
						
						$rootScope.dbTable.table[x][y][5].forEach($scope.highLightThem) //5odik elem ahova lephet
						$scope.showTable()
							
					};
					if($rootScope.dbTable.table[x][y][0] > 0 || 0 < $rootScope.tempMoveString.length) {

						$rootScope.tempMoveString += clickedString

						if($rootScope.tempMoveString.length < 3) {
							$rootScope.dbTable.table[x][y][8] = true;
						}

					}
					if($rootScope.tempMoveString.length > 3) {

						if($rootScope.dbTable.table[x][y][9] == true) {

							$scope.makeAMove($rootScope.tempMoveString)
							$rootScope.dbTable.wNext = !$rootScope.dbTable.wNext

							$rootScope.tempMoveString = ""

						} else {
							$rootScope.tempMoveString = $rootScope.tempMoveString[0] + $rootScope.tempMoveString[1]
						}

					}
					$scope.showTable()

				}
			}
		}
		$scope.highLightThem = function(arrayOfCoords) {
			$rootScope.dbTable.table[arrayOfCoords[0]][arrayOfCoords[1]][9] = true;
		}

		$scope.clearHighlights = function(onTable) {
			for(var i = 0; i < 8; i++) {
				for(var j = 0; j < 8; j++) {
					onTable[i][j][8] = false;
					onTable[i][j][9] = false;

				}
			}
		}
		$scope.sendChat= function (){
			
			$http.get('/chat?t='+$rootScope._id+'&c='+$rootScope.loginName+": "+$scope.sendThis)
				
					
					
	
			$scope.sendThis=""
			
		}
		
		
		
		$rootScope.updateSizes()
		console.log('appcontr ran')
		
		
		
		
		
		
	}
	
	
	
	function focusOnLogin() {
	
	window.setTimeout(function(){
		 document.getElementById("inputLoginUser").focus();
	},500)	
    // document.getElementById("inputLoginUser").focus();
	
	
	
}
	
	// $scope.firstView=function(){
	// 	showView('login.html')
	// }
	
	
	
	</script>
	
	
</head>

<body ng-app="appModule" ng-controller="ApplicationController">


	
	<nav ng-if="ran" width=100% class="navvv">
		<table>
			<tr>
				<td nowrap align="left">
		<a href="#" ng-click="showView('login.html')" ng-class="{ selected: viewName == 'login.html' }">{{inOrOut}}</a>
		<a href="#" ng-click="showView('lobby.html')" ng-class="{ selected: viewName == 'lobby.html' }">Lobby</a>
		<a href="#" ng-click="showView('board.html')" ng-class="{ selected: viewName == 'board.html' }">Chessboard</a>
		<a href="#" ng-click="showView('captain.html')" ng-class="{ selected: viewName == 'captain.html' }">Captain</a>
		
		<!--<a href="#" ng-click="showView('captain.html')" ng-class="{ selected: viewName == 'captain.html' }">Thinkers</a>-->
		</td>
		
		<td nowrap>
			
			<button  style="font-size:12px" ng-click="quickGame()">Instant Game</button>
			
		</td>
		
		<td>
			
			<form ng-if="cookieID==''" ng-submit="setID(thisID)">
				This PC's name:<input id="inputID" ng-model="thisID"></input>
			</form>
			
			
		</td>
		
		<td nowrap>v: {{viewName}} sv: {{subViewName}}</td>
		
		<td nowrap width=100% align="right">{{greetUser}}</td>
		</tr>
		</table>
	</nav>
	<div id="content" ng-include="viewName" onload="newView(viewName)"></div>
	<h1 ng-if="!(ran)">Please wait...</h1>

	</div>

</body>

</html>