<html>

<head>

	<link rel="stylesheet" type="text/css" href="chess.css">

	<!--<script src="js/frameworks/jquery.js"></script>-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    
    
	<!--<script src="js/frameworks/angular.js"></script>-->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>

	<script src="js/all/engine.js"></script>
	<script src="js/all/brandNewAi.js"></script>
	<script src="js/worker/deepening.js"></script>
	<script src="js/all/classes.js"></script>
	<script src="js/index/thinker.js"></script>



	<script>
		
		
		
		
		/////////////////////	temp stuff for debugging	//////////////////////////////////

		var tempConsole

        var testing={
            testAi:function(){
                
                var success=true
                
                var vals={}
                
                console.log('generate inited table')
                vals.initedTable=new Dbtable(1,2,3)
                
                console.log('make e2e4 move')
                moveInTable('e2e4',vals.initedTable)
                
                console.log('use singleThreadAi function (depth 3)')
                vals.firstResult=singleThreadAi(vals.initedTable,3)
                
                if(vals.firstResult.result.length==20){
                    console.log(".result.length is 20")
                }else{
                    throw new Error('.result.length is not 20')
                    console.log('.result.length:',vals.firstResult.result.length)
                    success=false
                }
                if(vals.firstResult.winningMove.moveTree=='b8c6,f2f3,0,g8f6,0'){
                    console.log(".winningMove.moveTree is 'b8c6,f2f3,0,g8f6,0'")
                }else{
                    throw new Error(".winningMove.moveTree is not 'b8c6,f2f3,0,g8f6,0'")
                    console.log('.winningMove.moveTree:',vals.firstResult.winningMove.moveTree)
                    success=false
                }
                if(vals.firstResult.winningMove.score==-12832){
                    console.log(".winningMove.score is -12832")
                }else{
                    throw new Error('.winningMove.score is not -12832')
                    console.log('.winningMove.score:',vals.firstResult.winningMove.score)
                    success=false
                }
                
                
                return success
                
                
                
                
            }
        }
        
        

        ///////////global vars////////////////
        
        
        var store={
            
            oopsStates:[]
            
            
        }


		//////////////////////////	cookie stuff	////////////////////////////////////////////////

		function setCookie(cname, cvalue, exdays) {

			var d = new Date();

			d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));

			var expires = "expires=" + d.toUTCString();

			document.cookie = cname + "=" + cvalue + "; " + expires;

		}

		function getCookie(cname) {

			var name = cname + "=";
			var ca = document.cookie.split(';');

			for (var i = 0; i < ca.length; i++) {
				var c = ca[i];
				while (c.charAt(0) == ' ') c = c.substring(1);
				if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
			}

			return "";

		}


		//init cookie vars

		var cookieId = ""
		var workerSpeed = ""
		var mainThreadSpeed = ""
		var cookieIdRnd = ""

		var clientMongoId = ''
		var userMongoId = ''


		//load cookies

		cookieId = getCookie("myID");
		cookieIdRnd = getCookie("rndId");

		clientMongoId = getCookie("clientMongoId");
		userMongoId = getCookie("userMongoId");



		if (cookieIdRnd == "") {
			cookieIdRnd = (Math.random() * Math.random()).toString()
			setCookie("rndId", cookieIdRnd, 365)
		}

		console.log('cookieIdRnd', cookieIdRnd)

		// mainThreadSpeed = Number(getCookie("mainThreadSpeed"));
		// workerSpeed = Number(getCookie("workerSpeed"));


		if (workerSpeed == "" || isNaN(workerSpeed)) {

			workerSpeed = 1 //temp val before first test		//should this be 0????

		}

		var sendID;

		if (cookieId == "") {



			sendID = cookieIdRnd


			// } else {

			// 	sendID = cookieId

		}

		var setID = function(id) {

			setCookie("myID", id, 365)
			cookieId = id
			sendID = id

			//should send some rename info to server to rename me!!!!!!!!!!!!!!!!!!!!!


		}



		var setWorkerSpeed = function(count, time) {

			var tempSpeed = Number(count) / Number(time)

			var percDiff = ~~(tempSpeed / Number(workerSpeed) * 100)

			tempSpeed = (workerSpeed + 2 * tempSpeed) / 3 //average of last few

			workerSpeed = tempSpeed

			setCookie("workerSpeed", workerSpeed, 365)

			return percDiff

		}

		var setSpeedCookies = function() {

			setWorkerSpeed(workerSpeed, 1)

		}




		/////////////////////	websocket stuff		//////////////////////////////////

		var showTable = function() {}

		var socketOn = false

		var socketID = undefined

		var socketSend = function(command, data, message, cb) {}


		function updateView($rootScope, $scope, data) {

			//console.log('updateview called',data)

			if ($rootScope.loginVals.viewName == data.viewName) {


				if ($rootScope.subViewName == data.subViewName) {
					//we're on the right view

					//console.log('updating ---- ', data.viewPart)
					eval("($rootScope." + data.viewPart + "=data.data)") // $rootScope.


					switch(data.viewPart){
						
						case 'dbTable.table':
						
							showTable(function() {
								$rootScope.$apply
							})
								
						break;
						
						case 'wPlayer':
						
							if($rootScope.wPlayer){
								
								$rootScope.draTable='wtable.html'
								
								
							}else{
								
								$rootScope.draTable='btable.html'
								
								
							}
						
						break;
						
					}


					//if (data.viewPart == 'dbTable.table') 


				} else {
					//view must have changed, let the server know maybe...
					// console.log('sorryyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy')


				}

			} else {
				//view must have changed, let the server know maybe...



			}

			$scope.$apply()

		}


		function sockets($rootScope, $scope) {
			if ("WebSocket" in window) {

				socketOn = true
					//alert("WebSocket is supported by your Browser!");

				// Let us open a web socket
				var ws = new WebSocket('ws://' + document.location.host + '/sockets/');

				ws.onopen = function() {
					// Web Socket is connected, send data using send()




					socketSend = function(command, data, message, cb) {

						var sendThis = {

							command: command,
							data: data,
							message: message,
							socketID: socketID
						}

						if (!cb) {
							var cb = function() {}
						}

						ws.send(JSON.stringify(sendThis), cb());

					}

					console.log("socket connected, let's say hello...")

					socketSend('Hello', {
							cookieIdRnd: cookieIdRnd,
							clientMongoId: clientMongoId
						}, 'Hello', function() {


							//console.log("socketSend 'hello' callback called")
						}) //init
						// console.log('cookieIdRnd again',cookieIdRnd)

				};

				ws.onmessage = function(evt) {
					var received = eval("(" + evt.data + ")");

					// console.log("socketMessage received:",received.message,received.data);

					switch (received.command) {
						
						case 'challenged':
						
							if(received.data.opponentsChoice){
								
								$rootScope.alertUser('Accept challenge',received.data.challenger+' is inviting you for a game, and letting you choose color.',['Accept, play with white.','Accept, play with black.','Decline'],received.data,10,'Decline')

								
							}else{
								
								if(received.data.wPlayer){
									
									$rootScope.alertUser('Accept challenge',received.data.challenger+' is inviting you for a game. You will play with white.',['Accept','Decline'],received.data,10,'Decline')

									
								}else{
									
									$rootScope.alertUser('Accept challenge',received.data.challenger+' is inviting you for a game. You will play with black.',['Accept','Decline'],received.data,10,'Decline')

									
									
								}
								
								
							}
						
							
						
						
						
						
						break;
						
						case 'refreshBrowser':
                            
                            ws.onclose = function () {}; // disable onclose handler first
                            ws.close()
                            
							location.reload(true)

							break;

						case 'updateDisplayedGames':

							$rootScope.displayedGames = received.data


							break;

						case 'userRegistered':

							//alert('User ' + received.data.name + ' registered.')
							$rootScope.alertUser('Success','User ' + received.data.name + ' registered.',['OK'],{},5,'OK')
							break;

						case 'userNotRegistered':

							//alert('User not registered, please register first!')
							$rootScope.alertUser('Register first!','User not registered, please register first!',['OK'],{},5,'OK')

							break;

						case 'wrongPwd':

							//alert("Username and password don't match, please try again!")
							$rootScope.alertUser('Wrong password',"Username and password don't match, please try again!",['OK'],{},5,'OK')

							break;

						case 'login':

							$rootScope.loggedIn = true
							$rootScope.isAdmin = received.data.isAdmin
							
							$rootScope.greetUser = 'Logged in as ' + received.data.name + '. '

							$rootScope.loginVals.inOrOut = 'Logoff' //displayed on nav when logged in
							$rootScope.loginName = received.data.name
							$rootScope.showView('lobby.html', 'default')




							break;

						case 'userExists':

							//alert('Username ' + received.data.name + ' already exists, please try another!')
							$rootScope.alertUser('Name exists','Username ' + received.data.name + ' already exists, please try another!',['OK'],{},5,'OK')

							break;

						case 'reHello':


							socketID = received.data.connectionID

							console.log('received connectionID', received.data.connectionID)

							$rootScope.socketID = received.data.connectionID
							sendID = $rootScope.socketID


							ifWorkers(startWorkers)


							if (!$rootScope.ran) {
								console.log('starting...')
								$rootScope.ran = true
								$rootScope.dbTable = new Dbtable(1, 2, 3)
								$rootScope.wPlayer = true
								$rootScope.wNext = true

								$rootScope.tempMoveString = ''
								$rootScope.opponentsNam = 'Computer'

								$rootScope.draTable = 'wtable.html'

								$rootScope.sTable = $rootScope.dbTable.table
								for (var i = 7; i >= 0; i--) {
									$rootScope.sTable[i] = []
									for (var j = 7; j >= 0; j--) {
										$rootScope.sTable[i][j] = [0, 0]
									}

								}

								$rootScope.showView('login.html')

							}


							break;

						case 'saveYourClientMongoId':

							//we said hello without a mongoID so we were given one, let's say hello again


							clientMongoId = received.data.clientMongoId
							setCookie('clientMongoId', clientMongoId, 365)

							//recall Hello

							console.log('clientMongoId ' + clientMongoId + ' registered, saying Hello again...')

							socketSend('Hello', {
									cookieIdRnd: cookieIdRnd,
									clientMongoId: clientMongoId
								}, 'Hello', function() {}) //init




							break;

						case 'openGame':

							if ($rootScope.wPlayer) {
								$scope.drTable("/wtable.html")
							} else {
								$scope.drTable("/btable.html")
							}

							$rootScope.rememberTablenum = received.data._id

							//$rootScope.dbTable={}

							$rootScope.showView('board.html', received.data._id)

							$rootScope.dbTable._id = received.data._id //temp hack!!!!!!!!!!!!!!!!!!!!!!!
							
							if(received.data.wPlayer){
								
								$rootScope.wPlayer=true
								$rootScope.draTable='wtable.html'
								
							}else{
								
								$rootScope.wPlayer=true
								$rootScope.draTable='btable.html'
								
								
								
							}
							
							$rootScope.wPlayer = received.data.wPlayer
							
							
							
							$rootScope.opponentsName = received.data.opponentsName

							$rootScope.tempMoveString = ""



							break;


						case 'showOnConsole':

							console.log('from server to console:', received.data)

							break;

						case 'task':


							mainWorker.postMessage

								({

								reqCommand: 'taskReceived',
								reqData: {
									command: received.data.command, //string
									data: received.data.data
								}

							})




							break;

						case 'updateView':

							updateView($rootScope, $scope, received.data)




							break;

						case 'updateDbTable':

							received.data.aiTable = undefined

							$rootScope.dbTable = received.data
							tempConsole = received.data
								//wplayer info kell itt!!

							$rootScope.wName = received.data.wName
							$rootScope.bName = received.data.bName



							$rootScope.updateSizes()


							$rootScope.showTable(function() {
								//console.log('cb cb cb cb cb cb cb cb cb cb')


								$rootScope.$on('$includeContentLoaded', function() {
									$rootScope.updateSizes(function() {
										console.log('updatesizes lefutott')
									})
								});
											
								

								// $rootScope.$apply
							})


							break;


						case 'lobbyState':




							//console.log('polling lobby')
							if (received.data.asktoopen) {
								////console.log('opening')

								$rootScope.dbTable._id = received.data.opentablenum
								$rootScope.showView('board.html', $rootScope.dbTable._id)
								$rootScope.wPlayer = received.data.opentablecolor
								$scope.opponentsName = received.data.opponentsname
								$rootScope.pollNum = 0

								$scope.openNow = true;

							}

							if (!($scope.lobbyPollNum == received.data.lobbypollnum)) {

								//////console.log('polling lobby')

								$scope.lobbyChatLines = received.data.lobbychat
								$scope.players = received.data.players
								$scope.players.unshift("Fastest thinker")
								$scope.players.unshift("Computer")
								$scope.players.unshift("Server")


								$scope.games = received.data.games
								$scope.players.sort(function(a, b) {
									return a.toLowerCase().localeCompare(b.toLowerCase());
								});
								$scope.lobbyPollNum = received.data.lobbyPollNum
									//showLobby(lobbyChatLines, players, games, $scope.lobbyPollNum)
									// 	if(!$scope.$$phase) {
									// 	$scope.$apply()
									// }

							}


							break;


					}
					if (!$scope.$$phase) {
						$scope.$apply()
					}

				};

				ws.onclose = function() {
					// websocket is closed.

					socketOn = false

					socketID = undefined

					console.log("socketConnection is closed, retry in 2s..");

					window.setTimeout(function() {
						if (!socketOn) sockets($rootScope, $scope)
					}, 2000)
				};
			} else {
				// The browser doesn't support WebSocket
				console.log("WebSocket NOT supported by your Browser!");
			}
		}


		var appModule = angular.module("appModule", []);

		appModule.controller("ApplicationController", ApplicationController)	
			

		function ApplicationController($rootScope, $scope, $timeout, $http, $interval, $compile) {
			
            testing.getDbTable=function(){
                return $rootScope.dbTable
            }
            
            testing.getAi=function(depth){
                if(!depth)depth=3
                return singleThreadAi(testing.getDbTable(),depth)
            }
            //testing.
			$rootScope.temp1={}
			
			$rootScope.alertButton=function(thisCase,passData){
				console.log('$rootScope.alertButton',thisCase,passData)
				switch (thisCase){
					
					case 'Accept challenge+Accept, play with white.':
						
						$scope.quickGame(passData.opponentsName,passData.challenger)
						
						
					break;
					
					case 'Accept challenge+Accept, play with black.':
						
						$scope.quickGame(passData.challenger,passData.opponentsName)
						
						
					break;
					
					case 'Accept challenge+Accept':
					
						if(passData.wPlayer){
							$scope.quickGame(passData.opponentsName,passData.challenger)
						}else{
							$scope.quickGame(passData.challenger,passData.opponentsName)
						}
					
					
					break;
					
					case 'Challenge player+White':
					
						console.log('challenging '+passData.opponentsName+' with white.')
						
						socketSend('challenge',{
							opponentsName:passData.opponentsName,
							wPlayer:true
						})
						
						
						
					break;
					case 'Challenge player+Black':
					
						console.log('challenging '+passData.opponentsName+' with black.')
						socketSend('challenge',{
							opponentsName:passData.opponentsName,
							wPlayer:false
						})
						
					break;
					case "Challenge player+Opponent's choice":
						
						console.log('challenging '+passData.opponentsName+", who get's to chose color.")
					socketSend('challenge',{
							opponentsName:passData.opponentsName,
							opponentsChoice:true
						})
						
					break;
					case "Challenge player+Random color":
						socketSend('challenge',{
							opponentsName:passData.opponentsName,
							wPlayer:(Math.random()>0.5)
						})
						console.log('jooo')
					break;
					// case 'Challenge player+Cancel':
					// 	// $rootScope.alertData=undefined
					// break;
					
					
					
				}
				
				$rootScope.alertData=undefined
				//$scope.$destroy()
					// console.log(thisCase)
				
			}
			
            
            
			$rootScope.autoButtonOnCountDown=function(alertID,countDown,callWithText){
				
				if($rootScope.alertData&&$rootScope.alertData.alertID==alertID){
					
					if(countDown>0){
						//console.log(countDown)
						$rootScope.alertCountDown=countDown
						$timeout(function(){
							$rootScope.autoButtonOnCountDown(alertID,countDown-1,callWithText)
						},1000)
					}else{
						//if($rootScope.alertData&&$rootScope.alertData.alertID==alertID){
							//t0, alert is still there
							
							$rootScope.alertButton(callWithText)
							
						// }else{
						// 	//alert is not there on t0
						// }
					}
				}
			}
			
			$rootScope.alertUser=function(heading,paragraph,buttons,passData,countDown,defaultButton){
				
				var alertID=Math.random()
				
				$rootScope.alertData={
					// html:'html/alerts/challenging.html',
					h:heading,
					p:paragraph,
					
					// li:[1,2,3],
					buttons:buttons,
					passData:passData,
					
					defaultButton:defaultButton,
					
					alertID:alertID
					
				}
				
				$timeout(function(){
					// console.log( "Handler for .focus() called." );
					 $( "#autoFoc" ).focus();
				
				},100) 
				
				$rootScope.autoButtonOnCountDown(alertID,countDown,heading+'+'+defaultButton)
				
				
				
			}
			
	
			
			// $rootScope.alertData={
			// 	// html:'html/alerts/challenging.html',
			// 	h:'Challenge player',
			// 	p:"You're about to challenge a player. Choose your color:",
				
			// 	// li:[1,2,3],
			// 	button:['White','Black',"Opponent's choice","Random color",'Cancel']
				
			// }
			//$rootScope.alertBox='html/alerts/challenging.html'
			

			if (!$rootScope.ran) {
				console.log('egyszer?')
				$rootScope.loginVals = {
					inOrOut: 'Login',
					viewName: 'login.html'
				}
                
                $rootScope.depth = 3
			}

			if (!socketOn) sockets($rootScope, $scope)




			var pollerMessage = function(event) {

				//console.log('something')

				switch (event.data.resCommand) {

					case undefined:

						break;

					case 'updateBusyThinkers':

						//		console.log(event.data.resData.busyThinkers)

						$rootScope.busyThinkers = event.data.resData.busyThinkers
						$scope.$apply()
						$rootScope.updateSizes()

						break;


				}


			}

			//var poller={}

			// ifWorkers(function(){

			// 	// poller=new Worker('js/poller.js')
			// 	// poller.onmessage = pollerMessage



			// },function(){
			// 	//no worker support



			// })




			$rootScope.cookieId = cookieId

			$rootScope.setID = function(id) {

				setID(id)

				$rootScope.cookieId = id


			}

			$scope.refreshAllBrowsers = function() {

				socketSend('refreshAllBrowsers')

			}

			$scope.setDepth = function(depth) {
				$rootScope.depth = depth
			}

			$rootScope.updateSizes = function(cb) {

				// var docuWidth=~~($(document).width()/1)

				console.log('updateSizes')

				//$('a').css({'font-size':docuWidth});
				//set nav sizes here!!!!!!!!!!!!!!!!!!!!!



				var sw = window.innerWidth
				var sh = window.innerHeight

				var sr = sh / sw

				if (sr < 0.8) {
					$rootScope.screenRatio = 0
				} else {

					if (sr < 1.1) {
						$rootScope.screenRatio = 1
					} else {

						if (sr < 1.5) {
							$rootScope.screenRatio = 2
						} else {
							$rootScope.screenRatio = 3
						}


					}

				}



				var nw = $('.navvv').width()
				var sbh = $('.statusBox').height()

				$('.frame-table').css({
					'width': nw + 'px'
				});
				$('.frame-table').css({
					'height': (sh - 50) + 'px'
				});



				switch ($rootScope.screenRatio) {

					case 0:

						$('.leftBar').css({
							'width': 130 + 'px'
						});


						$('.iderakd').css({
							'height': (1) + 'px'
						});
						$('.iderakd').css({
							'width': (1) + 'px'
						});

						$('.main-table').css({
							'height': (sh - 72) + 'px'
						});
						$('.main-table').css({
							'width': (sh - 72) + 'px'
						});


						$('.chatCell').css({
							'width': (sw - sh - 90) + 'px'
						});
						$('.chatCell').css({
							'height': (sh - 92) + 'px'
						});

						$('.chatInpt').css({
							'width': (sw - sh - 144) + 'px'
						});

						$('.moves').css({
							'height': (sh - sbh - 75) + 'px'
						});

						// $('.dtext').css({
						// 	'font-size': '1em'
						// });

						break;

					case 1:

						$('.leftBar').css({
							'width': 230 + 'px'
						});



						$('.tableAndChat').css({
							'width': (nw - 241) + 'px'
						});


						$('.chatCell').css({
							'width': (nw - 214) + 'px'
						});
						$('.chatCell').css({
							'height': (sh - sw + 342) + 'px'
						});

						$('.chatInpt').css({
							'width': (nw - 268) + 'px'
						});


						$('.iderakd').css({
							'height': (1) + 'px'
						});
						$('.iderakd').css({
							'width': (1) + 'px'
						});


						$('.main-table').css({
							'height': (nw - 215) + 'px'
						});
						$('.main-table').css({
							'width': (nw - 215) + 'px'
						});


						$('.moves').css({
							'height': (sh - sbh + 112) + 'px'
						});

						// $('.dtext').css({
						// 	'font-size': '1em'
						// });


						break;

					case 2:

						$('.leftBar').css({
							'width': 130 + 'px'
						});


						$('.tableAndChat').css({
							'width': (1) + 'px'
						});

						$('.iderakd').css({
							'height': (1) + 'px'
						});
						$('.iderakd').css({
							'width': (1) + 'px'
						});



						$('.chatCell').css({
							'width': (nw - 150) + 'px'
						});
						$('.chatCell').css({
							'height': (sh - nw + 42) + 'px'
						});

						$('.chatInpt').css({
							'width': (nw - 214) + 'px'
						});



						$('.main-table').css({
							'height': (nw - 150) + 'px'
						});
						$('.main-table').css({
							'width': (nw - 150) + 'px'
						});

						$('.moves').css({
							'height': (sh - sbh - 82) + 'px'
						});

						// $('.dtext').css({
						// 	'font-size': '1.2em'
						// });

						break;

					case 3:




						$('.leftBar').css({
							'height': (sh - nw - 68) + 'px'
						});

						$('.chatCell').css({
							'width': (nw - 148) + 'px'
						});
						$('.chatInpt').css({
							'width': (nw - 202) + 'px'
						});


						$('.chatCell').css({
							'height': (sh - nw - 90) + 'px'
						});

						$('.iderakd').css({
							'height': (1) + 'px'
						});
						$('.iderakd').css({
							'width': (1) + 'px'
						});

						$('.main-table').css({
							'height': (nw - 8) + 'px'
						});
						$('.main-table').css({
							'width': (nw - 8) + 'px'
						});

						$('.moves').css({
							'height': (sh - sbh - nw - 73) + 'px'
						});


						// $('.dtext').css({
						// 	'font-size': '1.5em'
						// });

						break;

				}

				if (cb) cb()

			}

			window.onresize = function() {


				//http://stackoverflow.com/questions/14902321/how-to-determine-if-a-resize-event-was-triggered-by-soft-keyboard-in-mobile-brow


				var t = $(document.activeElement).prop('type')
				if (t === 'text' || t === 'password') {
					// Logic for while keyboard is shown
				} else {
					// Logic for while keyboard is hidden

					$timeout($rootScope.updateSizes(), 800)


				}

			}

			var dletters = ["a", "b", "c", "d", "e", "f", "g", "h"]

			//$rootScope.loggedIn = false
			$scope.lobbyPollNum = 0

			$rootScope.pollNum = -2 //just in case

			


			$scope.askToStart = function(opponentsName) {
				//console.log('asktostart')
				if (opponentsName != $rootScope.loginName) {
					
					// console.log('asktostart')
					$rootScope.alertUser('Challenge player',"You're about to challenge "+opponentsName+". Choose your color:",['White','Black',"Opponent's choice","Random color",'Cancel'],{
						opponentsName:opponentsName
					},10,'Cancel')
			
				}else{
					
					//clicked to challange himself
					
					
				}
					//$http.get('/startGame?w=' + $rootScope.loginName + "&b=" + opponentsName)

			}

			/// 

			$scope.askToWatch = function(gameID) {

				$http.get('/watchGame?v=' + $rootScope.loginName + "&t=" + gameID)

			}
			$rootScope.applyIt = function() {

				console.log('should apply')

				if (!$scope.$$phase) {

					console.log('does apply')
					$scope.$apply()

				} //else{

				// 	console.log('apply: try again in 3s')
				// 	$interval($rootScope.applyIt(),3000)

				// }

			}

			$scope.quickGame = function(w,b) {


				//$rootScope.showView('board.html',)

				//$http.get('/startGame?w=' + $rootScope.loginName + "&b=" + 'Computer')

				// $scope.opponentsName = 'Computer'

				socketSend('quickGame', {
					w: w,//$rootScope.loginName,
					b: b//'Computer'
				}, 'startQuickGame for w:' + w +' b:'+b, function() {
					console.log("'startGame' callback")
				})

			}

			$scope.setTableNum = function(num) {

				var oldNum = $rootScope.dbTable._id

				$rootScope.dbTable._id = num
				$rootScope.pollNum = -1

				$http.get('/forcePopTable?t=' + oldNum + '&p=' + $rootScope.loginName + '&m=Went to t' + num)
				$rootScope.longPollTable()

			}

			// $scope.pollLobby = function() {

			// 	$scope.lobbyPromise = $interval(function() {

			// 		//refreshLobby()
			// 		if($rootScope.loginVals.viewName == 'lobby.html') {

			// 			console.log("'getLobby'??")

			// 		} else {


			// 		}
			// 	}, 1000); //setinterval stuff ends here

			// }

			// $scope.pollLobby()			//replaced with socketSend




			$scope.clickedItTrans = function(i, j) {
				
				var clickedField = [j, 8 - i]
				var clickedString = dletters[j] + (9 - i)

				if (!($scope.opponentsName == "Spectator")) {
					$scope.clickedIt(clickedField, clickedString)
				}
				
			}

			$scope.makeAMove = function(whatMove) {

					var moveStr = whatMove

					var dbTable = $rootScope.dbTable 
                       	
                    dbTable.command = ''
						
                    store.oopsStates[$rootScope.dbTable._id]=$.extend(true, {}, dbTable)
					
					$scope.clearHighlights(store.oopsStates[$rootScope.dbTable._id].table)
					
					dbTable = moveInTable(moveStr, dbTable, false)
                       
                       
                    dbTable._id = $rootScope.dbTable._id
					dbTable.desiredDepth = $rootScope.depth
                    
                    


					if (dbTable.wName == 'Computer' || dbTable.bName == 'Computer') {
						
                        dbTable.command = 'makeAiMove'
                        dbTable.moveTask=new MoveTaskN(dbTable)
                      
					}


					
					socketSend('moved', dbTable, 'moved', function() {

						$rootScope.dbTable.table = dbTable.table
						$rootScope.dbTable.wNext = dbTable.wNext
						$rootScope.dbTable.moves = dbTable.moves
                        
					})

			}

			$rootScope.takeItBack = function() {
				socketSend('moved', store.oopsStates[$rootScope.dbTable._id], 'moved', function() {
                    
					$rootScope.dbTable.table = store.oopsStates[$rootScope.dbTable._id].table
					$rootScope.dbTable.wNext = store.oopsStates[$rootScope.dbTable._id].wNext
					$rootScope.dbTable.moves = store.oopsStates[$rootScope.dbTable._id].moves

				})
			}

			$scope.refreshTable = function() {

				$http.get('/getTPollNum?t=' + $rootScope.dbTable._id)
					.success(function(response) {
						
                        if (!(response.tablepollnum == $rootScope.pollNum)) {
							$rootScope.pollNum = response.tablepollnum
								////console.log('calling getandshow')
							$rootScope.longPollTable()
							if (!$scope.$$phase) {
								$scope.$apply()
							}
						}

					})

			}

			$rootScope.showTable = function(cb) { //this will update the displayed table from the array

				//shit i need to rotate it first

				// for(var i=0;i<8;i++){
				// 					for (var j=0;j<8;j++){
				// 						var theSame=($rootScope.table[i][j][0]!=response.table[i][j][0])

				// 						$rootScope.table[i][j]=response.table[i][j]

				// 						if(theSame){

				// 							$rootScope.table[i][j][15]=true
				// 							//changed=true
				// 						}
				// 					}
				// 				}

				var tt
				if ($rootScope.sTable) {
					tt = $rootScope.sTable
					console.log('got prev. table')
				} else {
					console.log('else called')
					tt = new Dbtable(1, 2, 3).table
				}


				//if(!($rootScope.dbTable))$rootScope.dbTable={table:[]}
				//console.log()
				if ($rootScope.wPlayer) {

					for (var i = 0; i < 8; i++) {

						for (var j = 0; j < 8; j++) {

							var theSame = (tt[i][j][0] == $rootScope.dbTable.table[j][7 - i][0])

							tt[i][j] = $rootScope.dbTable.table[j][7 - i]

							if (!theSame) tt[i][j][15] = true

							if ((i + j) & 1) tt[i][j][7] = true
						}
					}

				} else {

					for (var i = 0; i < 8; i++) {

						for (var j = 0; j < 8; j++) {

							var theSame = (tt[i][j][0] == $rootScope.dbTable.table[7 - j][i][0])

							tt[i][j] = $rootScope.dbTable.table[7 - j][i]

							if (!theSame) tt[i][j][15] = true

							if ((i + j) & 1) tt[i][j][7] = true

						}
					}




				}




				$rootScope.sTable = tt

				//consoleTable=$rootScope.dbTable.table

				//$scope.$apply()

				if (cb) cb()

			}

			showTable = $rootScope.showTable

			$scope.login = function(user) {

				socketSend('loginUser', {
					name: user.name,
					pwd: user.pwd,
					stayLoggedIn: user.stayLoggedIn
				})


			}

			$scope.register = function(user) {

				if (user.pwd1 == user.pwd2) {
					if (!(user.pwd1 == undefined || user.rName == undefined || user.rName == "")) {


						socketSend('registerUser', {
							name: user.rName,
							pwd: user.pwd1
						})

					}
				} else {
					$rootScope.alertUser('Password mismatch',"Passwords don't match, try again!",['OK'],{},5,'OK')
				}
			}
			
			
			
			$scope.adminButtons=function(func,client,data){
				switch(func){
					
					case 'runClientSpeedTest':
					
						socketSend('clientSpeedTest',client)
					
					break;
					
					case 'refreshBrowser':
					
						socketSend('refreshBrowser',client)
					
					break;
					
					case 'setLastUser':
						client.setLastUserTo=data
						socketSend('setLastUser',client)
					
					break;
					
					
					
					
					
				}
				
				
			}

			$scope.newView = function(viewName) {
				if (viewName == 'board.html') {


					// $timeout($rootScope.updateSizes(), 800)

					if ($rootScope.wPlayer) {
						$scope.drTable("/wtable.html")
					} else {
						$scope.drTable("/btable.html")
					}
				} else {
					if (viewName == 'login.html') {

						focusOnLogin()

					} else {


						if (viewName == 'lobby.html') {

						}



					}
				}
			}

			$scope.drTable = function(viewName) {
				$rootScope.draTable = viewName;
			}



			$rootScope.showView = function(viewName, subViewName, requestUpdate) {

				//let the server know what we're watching

				if (!(subViewName)) {

					if (viewName == $rootScope.loginVals.viewName && $rootScope.subViewName) {
						subViewName = $rootScope.subViewName
					} else {
						subViewName = 'default'
					}

				}

				var newViewParts = []
					//var oldViewParts=$rootScope.activeViewParts

				console.log('test', viewName, $rootScope.loginVals.inOrOut)

				switch (viewName) {
					case 'login.html':

						newViewParts = [
							'default'
						]


						//console.log('inorout',$rootScope.inOrOut)
						if ($rootScope.loginVals.inOrOut == 'Logoff') {

							socketSend('logoff', {
								name: $rootScope.loginName
							})
							
							$rootScope.greetUser = ''
							$rootScope.loginVals.inOrOut = 'Login'
							$rootScope.loginName = 'someone'
							$rootScope.loggedIn = false
							$rootScope.isAdmin = false

						}

						


						break;

					case 'lobby.html':

						newViewParts = [
							'lobbyChat',
							'activeGames',
							'onlineUsers'
						]


						//
						break;

					case 'admin.html':

						newViewParts = [
							'clients',
							'activeViews',
                            'splitMoves',
                            'adminLog'
						]

						//

						break;

					case 'board.html':

						//if(subViewName=='default'&&$rootScope.dbTable._id)subViewName=$rootScope.dbTable._id

						newViewParts = [
							'dbTable.table',
							'dbTable.chat',
							'dbTable.moves',
							'busyThinkers',
							'dbTable.wNext',
							'wPlayer'

						]

						break;
				}

				//var oldViewParts=$rootScope.activeViewParts.slice()

				if (!($rootScope.activeViewParts)) $rootScope.activeViewParts = [] //init here

				socketSend('showView', {

					oldViewName: $rootScope.loginVals.viewName,
					oldSubViewName: $rootScope.subViewName,
					oldViewParts: $rootScope.activeViewParts.slice(),

					newViewName: viewName,
					newSubViewName: subViewName,
					newViewParts: newViewParts

				}, 'showView', function() {

					console.log('showView socketSend callback ran')

					$rootScope.loginVals.viewName = viewName;
					$rootScope.subViewName = subViewName;
					$rootScope.activeViewParts = newViewParts.slice()
					
					
					if (requestUpdate) {
					// socketSend('updateMe',{
	
						// })
	
						console.log('here would be "updateMe"')
	
						$rootScope.applyIt()
					} else {
						$rootScope.applyIt()
					}



				})

				

			}
            
            $scope.startAdminLog=function(){
                socketSend('startAdminLog')
            }
            $scope.stopAdminLog=function(){
                socketSend('stopAdminLog')
            }
            $scope.clearAdminLog=function(){
                socketSend('clearAdminLog')
            }

			$scope.clickedIt = function(clickedField, clickedString) {


				var x = clickedField[0]
				var y = clickedField[1]
				var clickedColor = false

				//console.log('testing',$rootScope.dbTable.table[x][y][5] , $rootScope.tempMoveString.length ,$rootScope.dbTable.wNext , $rootScope.wPlayer)	
				if ((!($rootScope.dbTable.table[x][y][5] == []) || $rootScope.tempMoveString.length > 0) && $rootScope.dbTable.wNext == $rootScope.wPlayer) {
					console.log('clickeit called', clickedField, clickedString)

					if (clickedString == $rootScope.tempMoveString) {
						$rootScope.dbTable.table[x][y][8] = false
						$scope.clearHighlights($rootScope.dbTable.table)
						$rootScope.showTable()
						$rootScope.tempMoveString = ""
					} else {

						if ($rootScope.dbTable.table[x][y][0] > 0 && $rootScope.tempMoveString == "") {
							//console.log('testtesttesttesttesttesttesttest')

							for (var i = 0; i < 8; i++) {
								for (var j = 0; j < 8; j++) {
									$rootScope.dbTable.table[i][j][15] = false

								}
							}


							$rootScope.dbTable.table[x][y][5].forEach($scope.highLightThem) //5odik elem ahova lephet
							$rootScope.showTable()

						};
						if ($rootScope.dbTable.table[x][y][0] > 0 || 0 < $rootScope.tempMoveString.length) {

							$rootScope.tempMoveString += clickedString

							if ($rootScope.tempMoveString.length < 3) {
								$rootScope.dbTable.table[x][y][8] = true;
							}

						}
						if ($rootScope.tempMoveString.length > 3) {

							if ($rootScope.dbTable.table[x][y][9] == true) {

								$scope.makeAMove($rootScope.tempMoveString)
								$rootScope.dbTable.wNext = !$rootScope.dbTable.wNext

								$rootScope.tempMoveString = ""

							} else {
								$rootScope.tempMoveString = $rootScope.tempMoveString[0] + $rootScope.tempMoveString[1]
							}

						}
						$rootScope.showTable()

					}
				}
			}
			$scope.highLightThem = function(arrayOfCoords) {
				$rootScope.dbTable.table[arrayOfCoords[0]][arrayOfCoords[1]][9] = true;
			}

			$scope.removeDisplayedGame = function(gameNo) {
				//console.log('removeGame',gameNo)
				socketSend('removeDisplayedGame', gameNo)
			}

			$scope.clearHighlights = function(onTable) {
				for (var i = 0; i < 8; i++) {
					for (var j = 0; j < 8; j++) {
						onTable[i][j][8] = false;
						onTable[i][j][9] = false;

					}
				}
			}
			$scope.sendChat = function(chatLine) {

                console.log('sending chat:',chatLine,$rootScope.dbTable._id)
                
				socketSend('boardChat',{
                    chatLine:chatLine,
                    gameNum:$rootScope.dbTable._id
                },'boardChat: '+chatLine,function(){
                    
                    $rootScope.temp1.chatInput=''
                    
                })

			}

            $scope.sendLobbyChat = function(chatLine) {
                
                //console.log('sending chat:',chatLine)

				socketSend('lobbyChat',{
                    chatLine:chatLine
                },'lobbyChat: '+chatLine,function(){
                    
                    $rootScope.temp1.lobbyChatInput=''
                    
                })
                
                

			}



			$rootScope.updateSizes()
			console.log('appcontr ran')
			
			$scope.instantGame = function(w,b) {


				// $scope.opponentsName = 'Computer'

				socketSend('quickGame', {
					w: $rootScope.loginName,
					b: 'Computer'
				}, 'startQuickGame for w:' + w +' b:'+b, function() {
					console.log("'startGame' callback")
				})

			}



		}
		
	



		function focusOnLogin() {

			window.setTimeout(function() {
					document.getElementById("inputLoginUser").focus();
				}, 500)
				// document.getElementById("inputLoginUser").focus();



		}

		// $scope.firstView=function(){
		// 	showView('login.html')
		// }
	</script>


</head>

<body ng-app="appModule" ng-controller="ApplicationController" class="docuBody">

	<div class="main-div" style="padding-bottom:0px;border-spacing:0px">


		<nav ng-if="ran" style="width: 100%;padding-bottom:0px;border-spacing:0px" class="navvv unselectable">
			<table style="padding-bottom:0px;border-spacing:0px;border-collapse: merge">
				<tr valign="bottom" style="padding-bottom:0px;border-spacing:0px;border-collapse: merge">
					
					<td nowrap>
						<button class="dtext" ng-click="instantGame(loginName,'Computer')">Instant Game</button>
					</td>
					
<!--indening the below leaves spaces between tabs on nav-->
					
<td nowrap style="padding-bottom:0px;border-spacing:0px;border-collapse: merge" valign="bottom"><div style="display: inline-block;white-space: nowrap;padding-bottom:0px;border-spacing:0px"><div style="display: inline-block;white-space: nowrap;" ng-class="{ passiveTab: loginVals.viewName != 'cv.html', activeTab: loginVals.viewName == 'cv.html' }">
&nbsp
<span ng-attr-title="About the author" class="dtext pointed" ng-click="showView('cv.html')">Author</span>
&nbsp
</div></div><div style="display: inline-block;white-space: nowrap;padding-bottom:0px;border-spacing:0px"><div style="display: inline-block;white-space: nowrap;" ng-class="{ passiveTab: loginVals.viewName != 'login.html', activeTab: loginVals.viewName == 'login.html' }">
&nbsp
<span ng-attr-title="Click here to {{loginVals.inOrOut}}" class="dtext pointed" ng-click="showView('login.html')">{{loginVals.inOrOut}}</span>
&nbsp
</div></div><div ng-if="loggedIn" style="display: inline-block;white-space: nowrap;padding-bottom:0px;border-spacing:0px"><div style="display: inline-block;white-space: nowrap;" ng-class="{ passiveTab: loginVals.viewName != 'lobby.html', activeTab: loginVals.viewName == 'lobby.html' }">
&nbsp
<span title="Click here to view the lobby" class="dtext pointed" ng-click="showView('lobby.html')">Lobby</span>
&nbsp
</div></div><div  ng-if="isAdmin" style="display: inline-block;white-space: nowrap;padding-bottom:0px;border-spacing:0px"><div style="display: inline-block;white-space: nowrap;" ng-class="{ passiveTab: loginVals.viewName != 'admin.html', activeTab: loginVals.viewName == 'admin.html' }">
&nbsp
<span title="Hello admin, please click here!" class="dtext pointed" ng-click="showView('admin.html')">Admin</span>
&nbsp
</div></div></td><td nowrap style="width: 100%;padding-bottom:0px;border-spacing:0px;border-collapse: merge" valign="bottom"><div ng-repeat="x in displayedGames" style="display: inline-block;white-space: nowrap;padding-bottom:0px;border-spacing:0px"><div style="display: inline-block;white-space: nowrap;" ng-class="{ passiveTab: loginVals.viewName != 'board.html' || subViewName != x.gameNo, activeTab: loginVals.viewName == 'board.html' && subViewName == x.gameNo }">
&nbsp
<span ng-attr-title="playing {{x.wPlayer&&('white')||('black')}} against {{x.opponentsName}}" class="dtext pointed" ng-click="showView('board.html',x.gameNo,true)">Game {{x.gameNo}}</span><span style="position:relative;top:-1px;background-position: 0px -0.5pt;"ng-click="removeDisplayedGame(x.gameNo)" class="pointed dtext radial">X</span>
</div></div></td>

<td class="dtext" nowrap align="right">{{greetUser}}</td>
				</tr>
			</table>
		</nav>


	</div>

	<div>
		
		
		
		<div ng-if="loginVals.viewName&&loginVals.viewName!=''" id="content" ng-include="'html/'+loginVals.viewName" onload="newView(viewName)">
			
		
		</div>
		<h1 ng-if="!(ran)">Please wait...</h1>

	</div>
	
	<div ng-if="alertData"style="
	
	
	
	
	
	position:absolute; 
	
	height:20vw;
	top:10vw;
	 
	right: 20vw;
    left: 20vw;
	
    margin-right: auto;
    margin-left: auto;
	
	margin-bottom: auto;
    margin-top: auto;
	
	z-index:2;
	
	min-height:200px;
	
 
  
	
	vertical-align:middle;
	
	background-color:rgba(55,55,155,0.8);color:white">
	
		
					<div ng-include="'/html/alert.html'">
							
	</div>
	
	
</body>

</html>